<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>××™×œ×™× ××”×œ×‘ â¤ï¸</title>
<link rel="manifest" href="manifest.json">

<style>
/* ×”×’×“×¨×ª ××©×ª× ×™× - ×‘×¨×™×¨×ª ××—×“×œ */
:root {
--primary: #4a90e2;
--primary-dark: #357abd;
--whatsapp: #25D366;
--bg: #e3f2fd;
--card: #f0f8ff;
--controls-bg: #e1f5fe;
--text: #1c1e21;
--border-radius: 16px;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
background-color: var(--bg);
color: var(--text);
margin: 0;
padding: 10px;
display: flex;
justify-content: center;
min-height: 100vh;
padding-bottom: 80px;
transition: background-color 0.4s ease;
}

.container {
width: 100%;
max-width: 600px;
background: var(--card);
padding: 20px;
border-radius: var(--border-radius);
box-shadow: 0 4px 12px rgba(0,0,0,0.08);
display: flex;
flex-direction: column;
gap: 15px;
position: relative;
min-height: 600px;
transition: background-color 0.4s ease;
}
/* ×›×•×ª×¨×ª ×•×›×¤×ª×•×¨ ×”×’×“×¨×•×ª */
.header-row { display: flex; justify-content: space-between; align-items: center; margin: 5px 0 15px 0; }
h1 { font-size: 1.8rem; margin: 0; color: var(--primary-dark); flex-grow: 1; text-align: center; }
.settings-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px; color: #555; transition: transform 0.3s; }
.settings-btn:hover { transform: rotate(45deg); color: var(--primary); }

/* ×›×¤×ª×•×¨ ×—×–×¨×” */
.back-btn {
background: #e4e6eb;
color: #333;
border: none;
padding: 10px 15px;
border-radius: 12px;
font-size: 0.95rem;
font-weight: bold;
cursor: pointer;
width: 100%;
display: block;
margin-bottom: 5px;
transition: 0.2s;
}
.back-btn:hover { background: #d0d2d6; }

/* ××–×•×¨ ×”×¤×§×“×™× (×™×¨×“ ×œ××˜×”) */
.controls-area {
display: flex;
flex-direction: column;
gap: 10px;
background: var(--controls-bg);
padding: 15px;
border-radius: 12px;
transition: background-color 0.4s ease;
margin-top: 10px; /* ×¨×•×•×— ×§×˜×Ÿ ××× ×©×™ ×”×§×©×¨ */
border-top: 1px solid rgba(0,0,0,0.05);
}

.top-row {
display: flex;
justify-content: center;
align-items: center;
width: 100%;
gap: 12px;
flex-wrap: wrap;
}
.sender-toggle { display: flex; background: rgba(255,255,255,0.5); border-radius: 20px; padding: 3px; height: fit-content; }
.sender-btn { border: none; background: transparent; padding: 6px 12px; border-radius: 16px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
.sender-btn.active { background: white; shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: bold; color: var(--primary-dark); }

.emoji-btn { background: white; border: 2px solid #ddd; border-radius: 20px; padding: 6px 12px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; transition: all 0.2s; color: #555; font-size: 0.9rem; height: fit-content; }
.emoji-btn.active { background: #ffeb3b; border-color: #fbc02d; color: #333; }
.length-wrapper { display: flex; flex-direction: column; align-items: center; }
.length-label-title { font-size: 0.8rem; font-weight: bold; color: #666; margin-bottom: 3px; }
.length-selector { display: flex; background: rgba(255,255,255,0.5); border-radius: 20px; padding: 3px; }
.length-selector label { flex: 1; text-align: center; padding: 6px 12px; border-radius: 16px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
.length-selector input { display: none; }
.length-selector input:checked + span { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: var(--primary); font-weight: bold; display: block; border-radius: 16px; padding: 4px 8px; }
.length-selector span { display: block; }

.grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; transition: all 0.3s ease; }
@media (min-width: 600px) { .grid-container { grid-template-columns: repeat(5, 1fr); } }
.category-btn { background: white; border: 1px solid #e0e0e0; padding: 15px 5px; border-radius: 12px; font-size: 1rem; cursor: pointer; font-weight: 500; color: #444; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: all 0.2s; }
.category-btn:hover { transform: translateY(-2px); border-color: var(--primary); }
.category-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); }

.dynamic-section { background: #f8f9fa; padding: 15px; border-radius: 12px; display: none; border: 1px solid #eee; animation: fadeIn 0.3s ease; }
.sub-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
.holidays-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
.sub-btn { background: white; border: 1px solid #ccc; padding: 12px; border-radius: 10px; font-size: 0.95rem; cursor: pointer; transition: 0.2s; }
.sub-btn.active { background: var(--primary-dark); color: white; border-color: var(--primary-dark); font-weight: bold; }

.section-title { font-size: 1.1rem; font-weight: bold; color: var(--primary-dark); margin-bottom: 10px; text-align: center; width: 100%; display:block;}

.input-row { display: flex; gap: 10px; }
input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
.generate-btn { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-top: 10px; }
.generate-btn:active { transform: scale(0.98); }
.generate-btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

/* --- ×¢×™×¦×•×‘ ××–×•×¨ ×”×¤×œ×˜ --- */
.output-container {
background: #fff9c4;
padding: 15px;
border-radius: 12px;
min-height: 80px;
border: 1px dashed #fbc02d;
font-size: 1.1rem;
line-height: 1.5;
margin-top: 15px;
}

.line-item {
display: flex;
align-items: center;
margin-bottom: 8px;
gap: 10px;
animation: fadeIn 0.3s ease;
}

.line-text {
flex: 1;
padding: 4px 8px;
border-radius: 8px;
border: 1px solid transparent;
transition: all 0.2s;
cursor: text;
}
.line-text:focus {
background: white;
border-color: var(--primary);
outline: none;
box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.delete-line-btn {
background: #ef5350;
color: white;
border: none;
border-radius: 50%;
width: 24px;
height: 24px;
font-size: 12px;
font-weight: bold;
cursor: pointer;
flex-shrink: 0;
display: flex;
align-items: center;
justify-content: center;
transition: 0.2s;
opacity: 0.7;
}
.delete-line-btn:hover { opacity: 1; transform: scale(1.1); }

/* ------------------------------------------- */
.actions-bar { display: flex; gap: 10px; margin-top: 10px; }
.action-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
.btn-copy { background: #e4e6eb; color: #1c1e21; }
.btn-whatsapp { background: var(--whatsapp); color: white; }
#loadingOverlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; border-radius: 16px; }
.spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.loading-text { font-size: 1.1rem; color: #555; font-weight: bold; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* --- ×ª×•×¡×¤×•×ª ×œ×× ×©×™ ×§×©×¨ ××œ×‘× ×™×™× --- */
.favorites-bar {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 10px;
margin-top: 20px;
padding-top: 20px;
border-top: 1px solid #eee;
}
.contact-wrapper { display: flex; flex-direction: column; align-items: center; gap: 4px; }
.contact-rect {
width: 100%; padding: 8px 4px; border-radius: 10px; text-align: center; font-weight: bold;
font-size: 0.9rem; color: white; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
transition: transform 0.2s, opacity 0.2s; white-space: nowrap; overflow: hidden;
text-overflow: ellipsis; text-shadow: 0 1px 2px rgba(0,0,0,0.2); min-height: 40px;
display: flex; align-items: center; justify-content: center;
}
.contact-rect:hover { transform: translateY(-2px); opacity: 0.9; }
.contact-rect.empty { background: #e0e0e0; color: #777; border: 1px dashed #aaa; box-shadow: none; text-shadow: none; }
.contact-label { font-size: 0.75rem; color: #666; text-align: center; }

/* --- ××•×“××œ ×”×’×“×¨×•×ª --- */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); z-index: 1000; display: none; justify-content: center; align-items: center; }
.modal-content { background: white; width: 95%; max-width: 450px; border-radius: 16px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 85vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
.modal-header h2 { margin: 0; font-size: 1.2rem; }
.close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
.settings-row { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 12px; display: flex; gap: 10px; align-items: center; }
.color-picker-wrapper { width: 40px; height: 40px; border-radius: 50%; overflow: hidden; border: 2px solid #ddd; flex-shrink: 0; cursor: pointer; }
.color-picker-wrapper input[type="color"] { width: 150%; height: 150%; margin: -25%; cursor: pointer; border: none; padding: 0; }
.setting-inputs { flex: 1; display: flex; flex-direction: column; gap: 5px; }
.setting-inputs input[type="text"], .setting-inputs input[type="tel"] { padding: 8px; font-size: 0.9rem; border: 1px solid #ddd; border-radius: 6px; }
.import-contact-btn { background: #e1f5fe; border: 1px solid #b3e5fc; border-radius: 8px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; transition: 0.2s; flex-shrink: 0; }
.import-contact-btn:hover { background: #b3e5fc; }
.save-settings-btn { width: 100%; background: var(--primary); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; margin-top: 10px; }
</style>
</head>
<body>

<div class="container">
<div id="loadingOverlay">
<div class="spinner"></div>
<span class="loading-text">×˜×•×¢×Ÿ ××œ×¤×™ ×‘×¨×›×•×ª ××”×¢× ×Ÿ...</span>
<span id="loadingStatus" style="font-size:0.9rem; color:#888; margin-top:5px;">××ª×—×‘×¨ ×œ×©×¨×ª...</span>
</div>

<div class="header-row">
<div style="width:30px"></div>
<h1>××™×œ×™× ××”×œ×‘ â¤ï¸</h1>
<button class="settings-btn" onclick="openSettings()" title="×”×’×“×¨×•×ª ×× ×©×™ ×§×©×¨">âš™ï¸</button>
</div>

<button class="back-btn" id="backBtn" onclick="goBack()">ğŸ”™ ×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™</button>

<div class="grid-container" id="mainGrid">
<button class="category-btn" style="background:#e0f7fa; border-color:#00bcd4;" onclick="selectCategory('morning_evening', this)">×‘×•×§×¨/×¢×¨×‘ â˜€ï¸ğŸŒ™</button>
<button class="category-btn" onclick="selectCategory('shabbat', this)">×©×‘×ª / ××•×¦"×© ğŸ•¯ï¸</button>
<button class="category-btn" onclick="selectCategory('holiday', this)">×—×’ ğŸ·</button>
<button class="category-btn" style="background:#fff9c4; border-color:#fbc02d;" onclick="selectCategory('chabad', this)">×—×‘"×“ ğŸ‘‘</button>
<button class="category-btn" onclick="selectCategory('birthday', this)">×™×•× ×”×•×œ×“×ª ğŸ‚</button>
<button class="category-btn" onclick="selectCategory('event', this)">××™×¨×•×¢ ğŸ’</button>
<button class="category-btn" onclick="selectCategory('birth', this)">×œ×™×“×” ğŸ‘¶</button>
<button class="category-btn" onclick="selectCategory('recovery', this)">×¨×¤×•××” ğŸ’Š</button>
<button class="category-btn" onclick="selectCategory('thank_you', this)">×ª×•×“×” ğŸ™</button>
<button class="category-btn" onclick="selectCategory('success', this)">×”×¦×œ×—×” ğŸ†</button>
<button class="category-btn" onclick="selectCategory('love', this)">××”×‘×” â¤ï¸</button>
</div>

<div id="morningEveningSection" class="dynamic-section">
<div id="timeOfDaySelector">
<h3>××” ×”×©×¢×”?</h3>
<div class="sub-grid" style="grid-template-columns: repeat(3, 1fr);">
<button class="sub-btn" onclick="selectTimeOfDay('morning', this)">×‘×•×§×¨ ×˜×•×‘ â˜€ï¸</button>
<button class="sub-btn" onclick="selectTimeOfDay('noon', this)">×¦×”×¨×™×™× ×˜×•×‘×™× ğŸŒ¤ï¸</button>
<button class="sub-btn" onclick="selectTimeOfDay('night', this)">×œ×™×œ×” ×˜×•×‘ ğŸŒ™</button>
</div>
</div>
<div id="timeTargetSelector" style="display:none; margin-top:15px;">
<h3>×œ××™ ×”×‘×¨×›×”?</h3>
<div class="sub-grid">
<button class="sub-btn" onclick="selectTimeTarget('general', this)">×›×œ×œ×™ âœ¨</button>
<button class="sub-btn" onclick="selectTimeTarget('husband', this)">×œ×‘×¢×œ×™ ğŸ¤µ</button>
<button class="sub-btn" onclick="selectTimeTarget('wife', this)">×œ××©×ª×™ ğŸ‘°</button>
</div>
</div>
</div>

<div id="shabbatSection" class="dynamic-section">
<div id="shabbatTimeSelector">
<h3>××” ×”×–××Ÿ ×¢×›×©×™×•?</h3>
<div class="sub-grid">
<button class="sub-btn" onclick="selectShabbatTime('shabbat')">ğŸ•¯ï¸ ×œ×§×¨××ª ×©×‘×ª</button>
<button class="sub-btn" onclick="selectShabbatTime('motzash')">ğŸ¸ ××•×¦××™ ×©×‘×ª</button>
</div>
</div>
<div id="shabbatTargetSelector" style="display:none;">
<h3 id="shabbatTargetTitle">×œ××™ ×”×‘×¨×›×”?</h3>
<div class="sub-grid">
<button class="sub-btn" onclick="selectSub('general', this)">×›×œ×œ×™ âœ¨</button>
<button class="sub-btn" onclick="selectSub('family', this)">×œ××©×¤×—×” ğŸ </button>
<button class="sub-btn" onclick="selectSub('wife', this)">×œ××©×ª×™ ğŸ‘°</button>
<button class="sub-btn" onclick="selectSub('husband', this)">×œ×‘×¢×œ×™ ğŸ¤µ</button>
<button class="sub-btn" onclick="selectSub('parents', this)">×œ×”×•×¨×™× ğŸ‘´ğŸ‘µ</button>
<button class="sub-btn" onclick="selectSub('kids', this)">×œ×™×œ×“×™× ğŸ§¸</button>
<button class="sub-btn" onclick="selectSub('brother', this)">×œ××— ğŸ‘¦</button>
<button class="sub-btn" onclick="selectSub('sister', this)">×œ××—×•×ª ğŸ‘§</button>
<button class="sub-btn" onclick="selectSub('friend_male', this)">×œ×—×‘×¨ ğŸ¤œğŸ¤›</button>
<button class="sub-btn" onclick="selectSub('friend_female', this)">×œ×—×‘×¨×” ğŸ‘¯â€â™€ï¸</button>
</div>
</div>
</div>

<div id="holidaySection" class="dynamic-section">
<div id="holidayNameSelector">
<h3>××™×–×” ×—×’ ×—×•×’×’×™×?</h3>
<div class="holidays-grid">
<button class="sub-btn" style="background:#e3f2fd; border-color:#2196f3; font-weight:bold;" onclick="selectHolidayName('rosh_chodesh', this)">×¨××© ×—×•×“×© ğŸŒ‘</button>
<button class="sub-btn" onclick="selectHolidayName('rosh_hashanah', this)">×¨"×”×©× ×” ğŸ</button>
<button class="sub-btn" onclick="selectHolidayName('yom_kippur', this)">×›×™×¤×•×¨ âš–ï¸</button>
<button class="sub-btn" onclick="selectHolidayName('sukkot', this)">×¡×•×›×•×ª ğŸŒ¿</button>
<button class="sub-btn" onclick="selectHolidayName('simchat_torah', this)">×©××—×ª ×ª×•×¨×” ğŸ“œ</button>
<button class="sub-btn" onclick="selectHolidayName('hanukkah', this)">×—× ×•×›×” ğŸ•</button>
<button class="sub-btn" onclick="selectHolidayName('tu_bishvat', this)">×˜"×• ×‘×©×‘×˜ ğŸŒ³</button>
<button class="sub-btn" onclick="selectHolidayName('purim', this)">×¤×•×¨×™× ğŸ­</button>
<button class="sub-btn" onclick="selectHolidayName('passover', this)">×¤×¡×— ğŸ·</button>
<button class="sub-btn" onclick="selectHolidayName('mimouna', this)">××™××•× ×” ğŸ¥</button>
<button class="sub-btn" onclick="selectHolidayName('yom_haatzmaut', this)">×”×¢×¦×××•×ª ğŸ‡®ğŸ‡±</button>
<button class="sub-btn" onclick="selectHolidayName('lag_baomer', this)">×œ"×’ ×‘×¢×•××¨ ğŸ”¥</button>
<button class="sub-btn" onclick="selectHolidayName('shavuot', this)">×©×‘×•×¢×•×ª ğŸŒ¾</button>
<button class="sub-btn" onclick="selectHolidayName('tu_beav', this)">×˜"×• ×‘××‘ â¤ï¸</button>
<button class="sub-btn" onclick="selectHolidayName('generic_holiday', this)">×›×œ×œ×™ ğŸ‰</button>
</div>
</div>
<div id="holidayTargetSelector" style="display:none; margin-top:15px;">
<h3>×œ××™ ×‘×¨×›×ª ×”×—×’?</h3>
<div class="sub-grid">
<button class="sub-btn" onclick="selectHolidayTarget('general', this)">×›×œ×œ×™ âœ¨</button>
<button class="sub-btn" onclick="selectHolidayTarget('family', this)">×œ××©×¤×—×” ğŸ </button>
<button class="sub-btn" onclick="selectHolidayTarget('wife', this)">×œ××©×ª×™ ğŸ‘°</button>
<button class="sub-btn" onclick="selectHolidayTarget('husband', this)">×œ×‘×¢×œ×™ ğŸ¤µ</button>
<button class="sub-btn" onclick="selectHolidayTarget('parents', this)">×œ×”×•×¨×™× ğŸ‘´ğŸ‘µ</button>
<button class="sub-btn" onclick="selectHolidayTarget('kids', this)">×œ×™×œ×“×™× ğŸ§¸</button>
<button class="sub-btn" onclick="selectHolidayTarget('brother', this)">×œ××— ğŸ‘¦</button>
<button class="sub-btn" onclick="selectHolidayTarget('sister', this)">×œ××—×•×ª ğŸ‘§</button>
<button class="sub-btn" onclick="selectHolidayTarget('friend_male', this)">×œ×—×‘×¨ ğŸ¤œğŸ¤›</button>
<button class="sub-btn" onclick="selectHolidayTarget('friend_female', this)">×œ×—×‘×¨×” ğŸ‘¯â€â™€ï¸</button>
</div>
</div>
</div>

<div id="chabadSection" class="dynamic-section">
<h3>×ª××¨×™×š ×—×¡×™×“×™</h3>
<div class="holidays-grid">
<button class="sub-btn" onclick="selectSub('chabad_19_kislev', this)">×™"×˜ ×›×¡×œ×• ğŸ“–</button>
<button class="sub-btn" onclick="selectSub('chabad_10_shevat', this)">×™' ×©×‘×˜ ğŸ•¯ï¸</button>
<button class="sub-btn" onclick="selectSub('chabad_11_nissan', this)">×™"× × ×™×¡×Ÿ ğŸ‘‘</button>
<button class="sub-btn" onclick="selectSub('chabad_3_tammuz', this)">×’' ×ª××•×– ğŸ•¯ï¸</button>
<button class="sub-btn" onclick="selectSub('chabad_12_tammuz', this)">×™"×‘-×™"×’ ×ª××•×– ğŸ”“</button>
<button class="sub-btn" onclick="selectSub('chabad_18_elul', this)">×—"×™ ××œ×•×œ âœ¨</button>
<button class="sub-btn" onclick="selectSub('chabad_5_tevet', this)">×”' ×˜×‘×ª ğŸ“š</button>
<button class="sub-btn" onclick="selectSub('chabad_22_shevat', this)">×›"×‘ ×©×‘×˜ ğŸ•¯ï¸</button>
<button class="sub-btn" onclick="selectSub('chabad_24_tevet', this)">×›"×“ ×˜×‘×ª ğŸ“œ</button>
<button class="sub-btn" onclick="selectSub('chabad_14_kislev', this)">×™"×“ ×›×¡×œ×• ğŸ’</button>
<button class="sub-btn" onclick="selectSub('chabad_2_iyar', this)">×‘' ××™×™×¨ ğŸš€</button>
<button class="sub-btn" onclick="selectSub('chabad_6_tishrei', this)">×•' ×ª×©×¨×™ ğŸ•¯ï¸</button>
</div>
<h3 style="margin-top:15px;">×œ××™ ×”×‘×¨×›×”?</h3>
<div class="sub-grid">
<button class="sub-btn" onclick="selectSub('general', this)">×›×œ×œ×™</button>
<button class="sub-btn" onclick="selectSub('family', this)">×œ××©×¤×—×”</button>
</div>
</div>

<div id="eventSection" class="dynamic-section">
<h3>××™×–×” ××™×¨×•×¢ ×—×•×’×’×™×?</h3>
<div class="sub-grid">
<button class="sub-btn" onclick="selectSub('wedding', this)">×—×ª×•× ×” ğŸ’</button>
<button class="sub-btn" onclick="selectSub('bar_mitzvah', this)">×‘×¨ ××¦×•×•×” ğŸ•</button>
<button class="sub-btn" onclick="selectSub('bat_mitzvah', this)">×‘×ª ××¦×•×•×” ğŸŒ¸</button>
<button class="sub-btn" onclick="selectSub('brit_milah', this)">×‘×¨×™×ª ××™×œ×” ğŸ‘¶</button>
<button class="sub-btn" onclick="selectSub('brita', this)">×‘×¨×™×ª×” ğŸ€</button>
<button class="sub-btn" onclick="selectSub('housewarming', this)">×—× ×•×›×ª ×‘×™×ª ğŸ”‘</button>
<button class="sub-btn" onclick="selectSub('henna', this)">×—×™× ×” ğŸ¤š</button>
</div>
</div>

<div id="birthSection" class="dynamic-section">
<h3>××–×œ ×˜×•×‘! ××” × ×•×œ×“?</h3>
<div class="sub-grid">
<button class="sub-btn" onclick="selectBirthType('birth_boy')">×œ×™×“×ª ×‘×Ÿ ğŸ’™ğŸ‘¶</button>
<button class="sub-btn" onclick="selectBirthType('birth_girl')">×œ×™×“×ª ×‘×ª ğŸ’–ğŸ‘¶</button>
</div>
<div id="birthSubTargetSection" style="display:none; margin-top:15px;">
<h3 id="birthTargetTitle">×œ××™ × ×•×œ×“?</h3>
<div class="sub-grid" id="birthTargetButtons"></div>
</div>
</div>

<div id="recoveryTargetSection" class="dynamic-section">
<h3>×œ××™ ×”×”×—×œ××”?</h3>
<span class="section-title">×’×‘×¨×™× ğŸ‘¨</span>
<div class="sub-grid">
<button class="sub-btn" onclick="selectRecoveryTarget('male', this)">×’×‘×¨ (×›×œ×œ×™)</button>
<button class="sub-btn" onclick="selectRecoveryTarget('dad', this)">××‘× ğŸ‘‘</button>
<button class="sub-btn" onclick="selectRecoveryTarget('brother', this)">××— ğŸ¦</button>
<button class="sub-btn" onclick="selectRecoveryTarget('son', this)">×‘×Ÿ/×™×œ×“ ğŸ‘¦</button>
<button class="sub-btn" onclick="selectRecoveryTarget('friend_male', this)">×—×‘×¨ ğŸ¤œğŸ¤›</button>
</div>
<span class="section-title">× ×©×™× ğŸ‘©</span>
<div class="sub-grid">
<button class="sub-btn" onclick="selectRecoveryTarget('female', this)">××™×©×” (×›×œ×œ×™×ª)</button>
<button class="sub-btn" onclick="selectRecoveryTarget('mom', this)">××× ğŸ’–</button>
<button class="sub-btn" onclick="selectRecoveryTarget('sister', this)">××—×•×ª ğŸŒ¸</button>
<button class="sub-btn" onclick="selectRecoveryTarget('daughter', this)">×‘×ª/×™×œ×“×” ğŸ‘§</button>
<button class="sub-btn" onclick="selectRecoveryTarget('friend_female', this)">×—×‘×¨×” ğŸ‘¯â€â™€ï¸</button>
</div>
</div>

<div id="thankYouTargetSection" class="dynamic-section">
<h3>×œ××™ ××•××¨×™× ×ª×•×“×”?</h3>
<div class="sub-grid" style="grid-template-columns: repeat(2, 1fr);">
<button class="sub-btn" onclick="selectThankYouTarget('male_general', this)">×’×‘×¨ (×›×œ×œ×™) ğŸ‘¨</button>
<button class="sub-btn" onclick="selectThankYouTarget('father', this)">××‘× ğŸ‘‘</button>
<button class="sub-btn" onclick="selectThankYouTarget('brother', this)">××— ğŸ¦</button>
<button class="sub-btn" onclick="selectThankYouTarget('friend_male', this)">×—×‘×¨ ğŸ»</button>
<button class="sub-btn" onclick="selectThankYouTarget('female_general', this)">××™×©×” (×›×œ×œ×™×ª) ğŸ‘©</button>
<button class="sub-btn" onclick="selectThankYouTarget('mother', this)">××× ğŸ’–</button>
<button class="sub-btn" onclick="selectThankYouTarget('sister', this)">××—×•×ª ğŸŒ¸</button>
<button class="sub-btn" onclick="selectThankYouTarget('friend_female', this)">×—×‘×¨×” ğŸ‘¯â€â™€ï¸</button>
</div>
</div>

<div id="genderSection" class="dynamic-section">
<h3>×œ××™ ×”×‘×¨×›×”?</h3>
<div class="sub-grid">
<button class="sub-btn" onclick="selectGenderGeneral('male', this)">×œ×’×‘×¨ ğŸ¤µ</button>
<button class="sub-btn" onclick="selectGenderGeneral('female', this)">×œ××™×©×” ğŸ‘°</button>
</div>
</div>

<div id="birthdaySection" class="dynamic-section">
<h3>×œ××™ ×™×•× ×”×”×•×œ×“×ª?</h3>
<div class="sub-grid" style="grid-template-columns: repeat(4, 1fr);">
<button class="sub-btn" onclick="selectGender('man', this)">×’×‘×¨ ğŸ‘¨</button>
<button class="sub-btn" onclick="selectGender('woman', this)">××™×©×” ğŸ‘©</button>
<button class="sub-btn" onclick="selectGender('boy', this)">×™×œ×“ ğŸ‘¦</button>
<button class="sub-btn" onclick="selectGender('girl', this)">×™×œ×“×” ğŸ‘§</button>
</div>
<div id="relationsContainer" style="display:none; margin-top:10px;">
<div class="sub-grid" id="relationsGrid" style="grid-template-columns: repeat(3, 1fr);"></div>
</div>
</div>

<div id="inputSection" class="dynamic-section" style="display:none;">
<div class="input-row">
<input type="text" id="nameInput" placeholder="×©× (××•×¤×¦×™×•× ×œ×™)" list="nameHistory">
<datalist id="nameHistory"></datalist>
<input type="number" id="ageInput" placeholder="×’×™×œ (××•×¤×¦×™×•× ×œ×™)">
</div>
</div>

<button class="generate-btn" id="genBtn" onclick="generateBlessing()" style="display:none;">ğŸ ×¦×•×¨ ×‘×¨×›×”</button>
<div class="output-container" id="output">
<div style="opacity:0.5; text-align:center; padding-top:10px;">×”×‘×¨×›×” ×ª×•×¤×™×¢ ×›××Ÿ...</div>
</div>

<div class="actions-bar">
<button class="action-btn btn-copy" onclick="copyText()">ğŸ“„ ×”×¢×ª×§</button>
<button class="action-btn btn-whatsapp" onclick="sendWhatsapp()">×©×œ×— ×œ×•×•×¦××¤</button>
</div>

<div class="favorites-bar"></div>

<div class="controls-area">
<div class="top-row">
<div class="sender-toggle">
<button class="sender-btn active" id="senderMale" onclick="setSenderGender('male')">×’×‘×¨ ğŸ‘¨</button>
<button class="sender-btn" id="senderFemale" onclick="setSenderGender('female')">××™×©×” ğŸ‘©</button>
</div>

<div class="length-wrapper">
<span class="length-label-title">×‘×¨×›×”</span>
<div class="length-selector">
<label><input type="radio" name="length" value="short" onchange="setLength('short')"><span>×§×¦×¨×”</span></label>
<label><input type="radio" name="length" value="long" onchange="setLength('long')" checked><span>××¨×•×›×”</span></label>
</div>
</div>

<button class="emoji-btn active" id="emojiBtn" onclick="toggleEmoji()">
<span id="emojiIcon">âœ…</span> ××™××•×’'×™
</button>
</div>
</div>

</div>

<div class="modal-overlay" id="settingsModal">
<div class="modal-content">
<div class="modal-header">
<h2>×× ×©×™ ×§×©×¨ ××”×™×¨×™×</h2>
<button class="close-modal" onclick="closeSettings()">âœ•</button>
</div>
<div id="settingsRows"></div>
<button class="save-settings-btn" onclick="saveSettings()">×©××•×¨ ×©×™× ×•×™×™×</button>
</div>
</div>

<script>
let generators = {};
// ××¦×‘ ×”××¢×¨×›×ª
let state = {
category: null,
subCategory: null,
shabbatTime: null,
holidayName: null,
holidayTarget: null,
chabadDate: null,
chabadTarget: null,
timeOfDay: null,
length: 'long',
gender: null, 
recipientGender: null, 
relationKey: null,
birthType: null,
useEmojis: true,
senderGender: 'male'
};

let contacts = [
{ name: '', phone: '', color: '#4a90e2' },
{ name: '', phone: '', color: '#4a90e2' },
{ name: '', phone: '', color: '#4a90e2' },
{ name: '', phone: '', color: '#4a90e2' },
{ name: '', phone: '', color: '#4a90e2' },
{ name: '', phone: '', color: '#4a90e2' }
];

const localBlessings = {
"birthday_partner_female": {
"openers": ["×‘×ª ×”×–×•×’ ×”××”×•×‘×”,", "×™×§×™×¨×ª×™,", "××”×‘×ª ×—×™×™,", "×”× ×¡×™×›×” ×©×œ×™,"],
"bodies": ["××™×Ÿ ××™×œ×™× ×œ×ª××¨ ×›××” ××ª ×—×©×•×‘×” ×œ×™.", "×××—×œ ×œ×š ×©×›×œ ×™×•× ×™×”×™×” ×™×¤×” ×•×–×•×”×¨ ×›××• ×”×—×™×•×š ×©×œ×š."],
"closings": ["××•×”×‘ ××•×ª×š.", "×©×œ×š ×ª××™×“."]
}
};
const wifeSuffixes = ["×”××•×©×œ××ª", "×”×™×¤×” ×©×œ×™", "××”×‘×ª ×—×™×™", "××œ×›×ª×™"];
const husbandSuffixes = ["×”××•×©×œ×", "×”×’×‘×¨ ×©×œ×™", "××”×‘×ª ×—×™×™", "××œ×š ×”×¢×•×œ×"];

// ×¨×©×™××ª ×”×§×‘×¦×™× ×œ×˜×¢×™× ×” (RAW)
const jsonFiles = [
"https://raw.githubusercontent.com/Yossi65/berkot/refs/heads/main/(%D7%91%D7%95%D7%A7%D7%A8%2C%20%D7%A6%D7%94%D7%A8%D7%99%D7%99%D7%9D%2C%20%D7%A2%D7%A8%D7%91).json",
"https://raw.githubusercontent.com/Yossi65/berkot/refs/heads/main/%D7%90%D7%99%D7%A8%D7%95%D7%A2.json",
"https://raw.githubusercontent.com/Yossi65/berkot/refs/heads/main/%D7%94%D7%A6%D7%9C%D7%97%D7%94%20.json",
"https://raw.githubusercontent.com/Yossi65/berkot/refs/heads/main/%D7%97%D7%91%D7%93.json",
"https://raw.githubusercontent.com/Yossi65/berkot/a115f2dacee968e59cce722dd783844c8b0eac7f/%D7%97%D7%92.json",
"https://raw.githubusercontent.com/Yossi65/berkot/refs/heads/main/%D7%99%D7%95%D7%9D%20%D7%94%D7%95%D7%9C%D7%93%D7%AA%20.json",
"https://raw.githubusercontent.com/Yossi65/berkot/refs/heads/main/%D7%9C%D7%90%D7%94%D7%91%D7%94.json",
"https://raw.githubusercontent.com/Yossi65/berkot/a115f2dacee968e59cce722dd783844c8b0eac7f/%D7%9C%D7%99%D7%93%D7%94.json",
"https://raw.githubusercontent.com/Yossi65/berkot/a115f2dacee968e59cce722dd783844c8b0eac7f/%D7%A8%D7%A4%D7%95%D7%90%D7%94.json",
"https://raw.githubusercontent.com/Yossi65/berkot/a115f2dacee968e59cce722dd783844c8b0eac7f/%D7%A9%D7%91%D7%AA%20%D7%95%D7%9E%D7%95%D7%A6%D7%90%D7%99%20%D7%A9%D7%91%D7%AA.json",
"https://raw.githubusercontent.com/Yossi65/berkot/a115f2dacee968e59cce722dd783844c8b0eac7f/%D7%AA%D7%95%D7%93%D7%94.json"
];

window.onload = function() {
const savedSender = localStorage.getItem('senderGender') || 'male';
setSenderGender(savedSender);

const savedEmojiState = localStorage.getItem('useEmojis');
if (savedEmojiState !== null) {
state.useEmojis = (savedEmojiState === 'true');
}
updateEmojiUI();

const savedLength = localStorage.getItem('blessingLength');
if (savedLength) {
state.length = savedLength;
const radio = document.querySelector(`input[name="length"][value="${savedLength}"]`);
if(radio) radio.checked = true;
}
loadAllBlessings();
loadNameHistory();
loadContacts();
renderContactButtons();
};

function loadContacts() {
const saved = localStorage.getItem('myContacts_v5');
if (saved) {
try {
let temp = JSON.parse(saved);
if(Array.isArray(temp)) {
contacts = temp;
while(contacts.length < 6) contacts.push({name:'', phone:'', color:'#4a90e2'});
if(contacts.length > 6) contacts = contacts.slice(0,6);
}
} catch(e) { console.error(e); }
}
}

function renderContactButtons() {
const container = document.querySelector('.favorites-bar');
container.innerHTML = '';
contacts.forEach((contact, index) => {
const wrapper = document.createElement('div');
wrapper.className = 'contact-wrapper';

const btn = document.createElement('div');
if (contact.phone) {
btn.className = 'contact-rect';
btn.style.backgroundColor = contact.color || '#4a90e2';
btn.innerText = contact.name || `××™×© ×§×©×¨ ${index+1}`;
btn.onclick = () => sendToContact(index);
} else {
btn.className = 'contact-rect empty';
btn.innerText = '+';
btn.onclick = () => openSettings();
}

const label = document.createElement('span');
label.className = 'contact-label';
label.innerText = `××™×© ×§×©×¨ ${index + 1}`;

wrapper.appendChild(btn);
wrapper.appendChild(label);
container.appendChild(wrapper);
});
}

function sendToContact(index) {
const contact = contacts[index];
if (!contact.phone) { openSettings(); return; }
let text = getVisibleText();
if(!text) { alert("×§×•×“× ×›×œ ×¦×•×¨ ×‘×¨×›×”!"); return; }
let cleanPhone = contact.phone.replace(/\D/g, '');
if (cleanPhone.startsWith('0')) cleanPhone = '972' + cleanPhone.substring(1);
window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(text)}`, '_blank');
}

function openSettings() {
const container = document.getElementById('settingsRows');
container.innerHTML = '';
contacts.forEach((contact, index) => {
const row = document.createElement('div');
row.className = 'settings-row';
row.innerHTML = `
<div class="color-picker-wrapper" title="×‘×—×¨ ×¦×‘×¢">
<input type="color" id="color${index}" value="${contact.color || '#4a90e2'}">
</div>
<button class="import-contact-btn" onclick="pickContact(${index})" title="×™×™×‘× ××× ×©×™ ×”×§×©×¨ ×‘×˜×œ×¤×•×Ÿ">ğŸ“’</button>
<div class="setting-inputs">
<input type="text" id="name${index}" placeholder="×©× (×œ××©×œ: ××‘×)" value="${contact.name}">
<input type="tel" id="phone${index}" placeholder="×˜×œ×¤×•×Ÿ (050...)" value="${contact.phone}">
</div>
`;
container.appendChild(row);
});
document.getElementById('settingsModal').style.display = 'flex';
}

async function pickContact(index) {
const isSupported = ('contacts' in navigator && 'ContactsManager' in window);
if (!isSupported) {
alert("×“×¤×“×¤×Ÿ ×–×” ××™× ×• ×ª×•××š ×‘×™×™×‘×•× ×™×©×™×¨. × × ×œ×”×–×™×Ÿ ×™×“× ×™×ª.");
return;
}
try {
const props = ['name', 'tel'];
const opts = { multiple: false };
const contactsSelected = await navigator.contacts.select(props, opts);
if (contactsSelected && contactsSelected.length > 0) {
const contact = contactsSelected[0];
if (contact.name && contact.name.length > 0) document.getElementById(`name${index}`).value = contact.name[0];
if (contact.tel && contact.tel.length > 0) document.getElementById(`phone${index}`).value = contact.tel[0];
}
} catch (ex) { console.log(ex); }
}

function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
function saveSettings() {
contacts.forEach((contact, index) => {
const nameEl = document.getElementById(`name${index}`);
const phoneEl = document.getElementById(`phone${index}`);
const colorEl = document.getElementById(`color${index}`);
if(nameEl) contact.name = nameEl.value;
if(phoneEl) contact.phone = phoneEl.value;
if(colorEl) contact.color = colorEl.value;
});
localStorage.setItem('myContacts_v5', JSON.stringify(contacts));
renderContactButtons();
closeSettings();
}

function loadNameHistory() {
let history = JSON.parse(localStorage.getItem('nameHistory') || '[]');
const datalist = document.getElementById('nameHistory');
datalist.innerHTML = '';
history.forEach(n => {
const option = document.createElement('option');
option.value = n;
datalist.appendChild(option);
});
}

function saveNameHistory(name) {
if(!name) return;
let history = JSON.parse(localStorage.getItem('nameHistory') || '[]');
if(!history.includes(name)) {
history.push(name);
localStorage.setItem('nameHistory', JSON.stringify(history));
loadNameHistory();
}
}

async function loadAllBlessings() {
const loadingStatus = document.getElementById('loadingStatus');
try {
const promises = jsonFiles.map(url => fetch(url).then(res => {
if(!res.ok) throw new Error(`× ×›×©×œ ×‘×˜×¢×™× ×ª: ${url}`);
return res.json();
}));

const results = await Promise.all(promises);
results.forEach(data => { generators = { ...generators, ...data }; });

document.getElementById('loadingOverlay').style.display = 'none';
document.getElementById('genBtn').disabled = false;
document.getElementById('genBtn').style.display = 'none';

} catch (error) {
console.error(error);
loadingStatus.innerText = "âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×";
setTimeout(() => document.getElementById('loadingOverlay').style.display = 'none', 2000);
}
}

function updateSenderUI() {
document.getElementById('senderMale').classList.remove('active');
document.getElementById('senderFemale').classList.remove('active');
if (state.senderGender === 'male') {
document.getElementById('senderMale').classList.add('active');
document.documentElement.style.setProperty('--primary', '#4a90e2');
document.documentElement.style.setProperty('--primary-dark', '#357abd');
document.documentElement.style.setProperty('--bg', '#b3e5fc');
document.documentElement.style.setProperty('--card', '#f0f8ff');
document.documentElement.style.setProperty('--controls-bg', '#e1f5fe');
} else {
document.getElementById('senderFemale').classList.add('active');
document.documentElement.style.setProperty('--primary', '#e91e63');
document.documentElement.style.setProperty('--primary-dark', '#c2185b');
document.documentElement.style.setProperty('--bg', '#f8bbd0');
document.documentElement.style.setProperty('--card', '#fff0f5');
document.documentElement.style.setProperty('--controls-bg', '#fce4ec');
}
}

function setSenderGender(g) {
state.senderGender = g;
localStorage.setItem('senderGender', g);
updateSenderUI();
}

function setLength(len) {
state.length = len;
localStorage.setItem('blessingLength', len);
}

const emojis = {
shabbat: ["ğŸ•¯ï¸", "ğŸ·", "âœ¨", "ğŸ¥–", "ğŸ•", "ğŸ‡", "ğŸ¤", "ğŸ•Šï¸", "ğŸ¡", "ğŸ’"],
motzash: ["ğŸ¸", "ğŸ•¯ï¸", "ğŸ·", "âœ¨", "ğŸŒš", "ğŸ¶", "ğŸ’«", "ğŸ¯", "ğŸ§¿", "ğŸŒŸ"],
morning: ["â˜€ï¸", "â˜•", "ğŸŒ¼", "ğŸ¥", "ğŸ§¡", "âœ¨", "×™×•× × ×¤×œ×"],
noon: ["ğŸŒ¤ï¸", "ğŸ¥—", "ğŸ¥¤", "ğŸ˜", "ğŸ’ª", "×”××©×š ×™×•× × ×¢×™×"],
night: ["ğŸŒ™", "â­", "ğŸ’¤", "ğŸ›ï¸", "âœ¨", "×—×œ×•××•×ª ×¤×–"],
wedding: ["ğŸ’", "ğŸ’’", "ğŸ¥‚", "ğŸ¤µ", "ğŸ‘°"],
bar_mitzvah: ["ğŸ“–", "ğŸ¬", "ğŸ•", "âœ¡ï¸", "ğŸ’™"],
bat_mitzvah: ["ğŸ“–", "ğŸŒ¸", "ğŸ•", "âœ¡ï¸", "ğŸ’–"],
brit_milah: ["ğŸ‘¶", "ğŸ¼", "ğŸ’™", "âœ¡ï¸"],
brita: ["ğŸ‘¶", "ğŸ¼", "ğŸ’–", "ğŸŒ¸"],
birth_boy: ["ğŸ‘¶", "ğŸ’™", "ğŸ¼", "ğŸš™", "ğŸ§¸"],
birth_girl: ["ğŸ‘¶", "ğŸ’–", "ğŸ€", "ğŸŒ¸", "ğŸ¦„"],
housewarming: ["ğŸ ", "ğŸ”‘", "ğŸª´", "ğŸ§¿"],
henna: ["ğŸ¤š", "ğŸ¬", "ğŸ•Œ", "ğŸ‘˜"],
birthday: ["ğŸ‚", "ğŸ¥³", "ğŸ", "ğŸˆ", "ğŸ°"],
general: ["âœ¨", "ğŸŒ¸", "ğŸ’«", "ğŸŒŸ", "ğŸ™Œ", "ğŸ’", "ğŸ’", "ğŸ¦‹", "ğŸŒˆ", "â˜€ï¸"],
recovery: ["ğŸ’Š", "ğŸ©º", "ğŸ’ª", "â¤ï¸"],
love: ["â¤ï¸", "ğŸ˜", "ğŸ’‹", "ğŸ’˜", "ğŸŒ¹"],
success: ["ğŸ†", "ğŸ’¼", "ğŸš€", "ğŸ“ˆ", "â­", "ğŸ’°"],
thank_you: ["ğŸ™", "ğŸ’", "ğŸ’–", "ğŸŒº"],
rosh_hashanah: ["ğŸ", "ğŸ¯", "ğŸ"],
hanukkah: ["ğŸ•", "ğŸ©", "ğŸ•¯ï¸"],
passover: ["ğŸ·", "ğŸ¥¬"],
purim: ["ğŸ­", "ğŸ·"],
tu_bishvat: ["ğŸŒ³", "ğŸŒ±", "ğŸ‡", "ğŸŠ", "ğŸŒ§ï¸"],
simchat_torah: ["ğŸ“œ", "ğŸ’ƒ", "ğŸ•", "ğŸ™Œ"],
yom_haatzmaut: ["ğŸ‡®ğŸ‡±", "ğŸ†", "ğŸ’™", "ğŸ–"],
lag_baomer: ["ğŸ”¥", "ğŸ¥”", "ğŸ•¯ï¸", "ğŸ¹"],
tu_beav: ["â¤ï¸", "ğŸ’‘", "ğŸ’", "ğŸ’Œ"],
rosh_chodesh: ["ğŸŒ‘", "ğŸ“…", "âœ¨", "ğŸ™"],
mimouna: ["ğŸ¥", "ğŸ¯", "ğŸª", "ğŸª•"],
chabad: ["ğŸ‘‘", "ğŸ•¯ï¸", "ğŸ•", "ğŸ“œ", "ğŸ“–"]
};

function updateEmojiUI() {
const btn = document.getElementById('emojiBtn');
const icon = document.getElementById('emojiIcon');
if (state.useEmojis) {
btn.classList.add('active');
icon.innerText = "âœ…";
} else {
btn.classList.remove('active');
icon.innerText = "âšª";
}
}

function toggleEmoji() {
state.useEmojis = !state.useEmojis;
localStorage.setItem('useEmojis', state.useEmojis);
updateEmojiUI();
}

function goBack() {
let currentEmojiState = state.useEmojis;
let currentSender = state.senderGender;
let currentLength = state.length;
state = {
category: null,
subCategory: null,
shabbatTime: null,
holidayName: null,
holidayTarget: null,
chabadDate: null,
chabadTarget: null,
timeOfDay: null,
length: currentLength,
gender: null,
recipientGender: null,
relationKey: null,
birthType: null,
useEmojis: currentEmojiState,
senderGender: currentSender
};
document.getElementById('nameInput').value = "";
document.getElementById('ageInput').value = "";
document.getElementById('output').innerHTML = '<div style="opacity:0.5; text-align:center; padding-top:10px;">×”×‘×¨×›×” ×ª×•×¤×™×¢ ×›××Ÿ...</div>';
document.getElementById('mainGrid').style.display = 'grid';
document.getElementById('genBtn').style.display = 'none';
document.querySelectorAll('.dynamic-section').forEach(el => el.style.display = 'none');
document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
document.getElementById('holidayTargetSelector').style.display = 'none';
document.getElementById('timeTargetSelector').style.display = 'none';
updateSenderUI();
}

function selectCategory(cat, btn) {
state.category = cat;
document.getElementById('mainGrid').style.display = 'none';
document.getElementById('inputSection').style.display = 'block';
document.querySelectorAll('.dynamic-section').forEach(el => el.style.display = 'none');

if (cat === 'morning_evening') {
document.getElementById('morningEveningSection').style.display = 'block';
document.getElementById('timeTargetSelector').style.display = 'none';
}
else if (cat === 'shabbat') {
document.getElementById('shabbatSection').style.display = 'block';
document.getElementById('shabbatTimeSelector').style.display = 'block';
document.getElementById('shabbatTargetSelector').style.display = 'none';
}
else if (cat === 'holiday') {
document.getElementById('holidaySection').style.display = 'block';
document.getElementById('holidayNameSelector').style.display = 'block';
document.getElementById('holidayTargetSelector').style.display = 'none';
}
else if (cat === 'chabad') {
document.getElementById('chabadSection').style.display = 'block';
}
else if (cat === 'event') document.getElementById('eventSection').style.display = 'block';
else if (cat === 'birth') {
document.getElementById('birthSection').style.display = 'block';
document.getElementById('birthSubTargetSection').style.display = 'none';
}
else if (cat === 'birthday') document.getElementById('birthdaySection').style.display = 'block';
else if (cat === 'recovery') {
document.getElementById('recoveryTargetSection').style.display = 'block';
}
else if (cat === 'thank_you') {
document.getElementById('thankYouTargetSection').style.display = 'block';
}
else if (['success', 'love'].includes(cat)) {
document.getElementById('genderSection').style.display = 'block';
} else {
document.getElementById('genBtn').style.display = 'block';
}
}

function selectTimeOfDay(time, btn) {
state.timeOfDay = time;
const btns = document.querySelectorAll('#timeOfDaySelector .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('timeTargetSelector').style.display = 'block';
document.getElementById('genBtn').style.display = 'none';
}

function selectTimeTarget(target, btn) {
state.subCategory = target;
if (target === 'husband') state.recipientGender = 'male';
if (target === 'wife') state.recipientGender = 'female';
const btns = document.querySelectorAll('#timeTargetSelector .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('genBtn').style.display = 'block';
}

function selectShabbatTime(time) {
state.shabbatTime = time;
const btns = document.querySelectorAll('#shabbatTimeSelector .sub-btn');
btns.forEach(b => b.classList.remove('active'));
event.target.classList.add('active');
document.getElementById('shabbatTargetSelector').style.display = 'block';
document.getElementById('genBtn').style.display = 'block';
}

function selectSub(type, btn) {
if (type.startsWith('chabad_')) {
state.chabadDate = type;
let parent = btn.parentElement;
parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
if (state.chabadTarget) document.getElementById('genBtn').style.display = 'block';
return;
}
if (state.category === 'chabad' && !type.startsWith('chabad_')) {
state.chabadTarget = type;
let parent = btn.parentElement;
parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
if (state.chabadDate) document.getElementById('genBtn').style.display = 'block';
return;
}

state.subCategory = type;
const maleTargets = ['husband', 'brother', 'friend_male', 'dad', 'grandson', 'boy'];
const femaleTargets = ['wife', 'sister', 'friend_female', 'mom', 'granddaughter', 'girl'];
if (maleTargets.includes(type)) state.recipientGender = 'male';
if (femaleTargets.includes(type)) state.recipientGender = 'female';

let parent = btn.parentElement;
parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('genBtn').style.display = 'block';
}

function selectHolidayName(hName, btn) {
state.holidayName = hName;
const btns = document.querySelectorAll('#holidayNameSelector .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('holidayTargetSelector').style.display = 'block';
document.getElementById('genBtn').style.display = 'block';
}

function selectHolidayTarget(target, btn) {
state.holidayTarget = target;
if (['husband', 'brother', 'friend_male', 'father'].includes(target)) state.recipientGender = 'male';
if (['wife', 'sister', 'friend_female', 'mother'].includes(target)) state.recipientGender = 'female';
const btns = document.querySelectorAll('#holidayTargetSelector .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
}

function selectBirthType(type) {
state.birthType = type;
const btns = document.querySelectorAll('#birthSection > .sub-grid > .sub-btn');
btns.forEach(b => b.classList.remove('active'));
event.target.classList.add('active');

const targetContainer = document.getElementById('birthTargetButtons');
targetContainer.innerHTML = '';
document.getElementById('birthSubTargetSection').style.display = 'block';
document.getElementById('birthTargetTitle').innerText = (type === 'birth_boy') ? "×œ××™ × ×•×œ×“ ×”×‘×Ÿ?" : "×œ××™ × ×•×œ×“×” ×”×‘×ª?";

const targets = (type === 'birth_boy') ?
[
{key: 'brother', label: '×œ××— ğŸ‘¦'},
{key: 'friend', label: '×œ×—×‘×¨ ğŸ¤œğŸ¤›'},
{key: 'neighbor', label: '×œ×©×›×Ÿ ğŸ '},
{key: 'family', label: '×œ×‘×Ÿ ××©×¤×—×” ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦'}
] :
[
{key: 'sister', label: '×œ××—×•×ª ğŸ‘§'},
{key: 'friend', label: '×œ×—×‘×¨×” ğŸ‘¯â€â™€ï¸'},
{key: 'neighbor', label: '×œ×©×›× ×” ğŸ '},
{key: 'family', label: '×œ×‘×ª ××©×¤×—×” ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦'}
];

targets.forEach(t => {
const b = document.createElement('button');
b.className = 'sub-btn';
b.innerText = t.label;
b.onclick = (e) => selectBirthSubTarget(t.key, e.target);
targetContainer.appendChild(b);
});
}

function selectBirthSubTarget(target, btn) {
state.subCategory = target;
const btns = document.querySelectorAll('#birthTargetButtons .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('genBtn').style.display = 'block';
}

function selectRecoveryTarget(target, btn) {
state.subCategory = target;
if(['male', 'dad', 'brother', 'son', 'friend_male'].includes(target)) state.recipientGender = 'male';
if(['female', 'mom', 'sister', 'daughter', 'friend_female'].includes(target)) state.recipientGender = 'female';

const btns = document.querySelectorAll('#recoveryTargetSection .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('genBtn').style.display = 'block';
}

function selectThankYouTarget(target, btn) {
state.subCategory = target;
if(['male_general', 'father', 'brother', 'friend_male'].includes(target)) state.recipientGender = 'male';
if(['female_general', 'mother', 'sister', 'friend_female'].includes(target)) state.recipientGender = 'female';

const btns = document.querySelectorAll('#thankYouTargetSection .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('genBtn').style.display = 'block';
}

function selectGenderGeneral(g, btn) {
state.gender = g;
state.recipientGender = g;
let parent = btn.parentElement;
parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('genBtn').style.display = 'block';
}

function selectGender(gender, btn) {
state.gender = gender;
if (gender === 'man' || gender === 'boy') state.recipientGender = 'male';
if (gender === 'woman' || gender === 'girl') state.recipientGender = 'female';

let parent = btn.parentElement;
parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');

const relationsMap = {
man: [
{ label: "×—×‘×¨ ğŸ»", key: "friend_male" },
{ label: "××— ğŸ‘Š", key: "brother" },
{ label: "××‘× ğŸ‘‘", key: "dad" },
{ label: "×‘×¢×œ×™ ğŸ’", key: "husband" },
{ label: "×‘×Ÿ ×–×•×’×™ ğŸ’‘", key: "partner_male" }
],
woman: [
{ label: "×—×‘×¨×” ğŸ‘¯â€â™€ï¸", key: "friend_female" },
{ label: "××—×•×ª ğŸŒ¸", key: "sister" },
{ label: "××× ğŸ‘‘", key: "mom" },
{ label: "××©×ª×™ ğŸ’", key: "wife" },
{ label: "×‘×ª ×–×•×’×ª×™ ğŸ’‘", key: "partner_female" }
],
boy: [
{ label: "×™×œ×“ âš½", key: "boy" },
{ label: "×‘×Ÿ ğŸ’™", key: "son" },
{ label: "× ×›×“ ğŸ§¸", key: "boy" },
{ label: "×—×‘×¨ ğŸš²", key: "boy" }
],
girl: [
{ label: "×™×œ×“×” ğŸ€", key: "girl" },
{ label: "×‘×ª ğŸ’–", key: "daughter" },
{ label: "× ×›×“×” ğŸ¦„", key: "girl" },
{ label: "×—×‘×¨×” ğŸ‘­", key: "girl" }
]
};
const grid = document.getElementById('relationsGrid');
grid.innerHTML = '';
(relationsMap[gender] || []).forEach(relItem => {
const b = document.createElement('button');
b.className = 'sub-btn';
b.innerText = relItem.label;
b.onclick = (e) => {
state.relationKey = relItem.key;
if (['husband','partner_male','brother','friend_male','son','dad'].includes(relItem.key)) state.recipientGender = 'male';
if (['wife','partner_female','sister','friend_female','daughter','mom'].includes(relItem.key)) state.recipientGender = 'female';
grid.querySelectorAll('.sub-btn').forEach(x => x.classList.remove('active'));
e.target.classList.add('active');
};
grid.appendChild(b);
});
document.getElementById('relationsContainer').style.display = 'block';
document.getElementById('genBtn').style.display = 'block';
}

function getDistinctRandom(arr, count) {
if (!arr || arr.length === 0) return [];
const shuffled = [...arr].sort(() => 0.5 - Math.random());
return shuffled.slice(0, count);
}

function smartGrammarFix(text) {
let clean = text;
if (state.senderGender === 'female') {
const senderReplacements = [
{ m: "×××—×œ", f: "×××—×œ×ª" }, { m: "××•×”×‘", f: "××•×”×‘×ª" }, { m: "××¢×¨×™×š", f: "××¢×¨×™×›×”" },
{ m: "×©×•×œ×—", f: "×©×•×œ×—×ª" }, { m: "×‘×˜×•×—", f: "×‘×˜×•×—×”" }, { m: "×—×•×©×‘", f: "×—×•×©×‘×ª" },
{ m: "××ª×’×¢×’×¢", f: "××ª×’×¢×’×¢×ª" }, { m: "××•×§×™×¨", f: "××•×§×™×¨×”" }, { m: "××××™×Ÿ", f: "××××™× ×”" },
{ m: "×¡×•××š", f: "×¡×•××›×ª" }, { m: "××—×–×™×§", f: "××—×–×™×§×”" }, { m: "××•×“×”", f: "××•×“×”" },
{ m: "×›×•×ª×‘", f: "×›×•×ª×‘×ª" }, { m: "××‘×§×©", f: "××‘×§×©×ª" }
];
senderReplacements.forEach(pair => {
clean = clean.replace(new RegExp(pair.m, 'g'), pair.f);
});
}
if (state.recipientGender) {
if (state.recipientGender === 'male') {
const toMaleMap = [
{ wrong: "×™×§×¨×”", right: "×™×§×¨" }, { wrong: "××”×•×‘×”", right: "××”×•×‘" },
{ wrong: "××“×”×™××”", right: "××“×”×™×" }, { wrong: "××§×¡×™××”", right: "××§×¡×™×" },
{ wrong: "××•×©×œ××ª", right: "××•×©×œ×" }, { wrong: "×”×˜×•×‘×”", right: "×”×˜×•×‘" },
{ wrong: "××ª", right: "××ª×”" }, { wrong: "×©×œ×š", right: "×©×œ×š" },
{ wrong: "×‘×©×‘×™×œ×š", right: "×‘×©×‘×™×œ×š" }, { wrong: "××œ×™×™×š", right: "××œ×™×™×š" },
{ wrong: "× ×”×“×¨×ª", right: "× ×”×“×¨" }, { wrong: "×—×©×•×‘×”", right: "×—×©×•×‘" },
{ wrong: "×‘×¨×™××”", right: "×‘×¨×™×" }, { wrong: "×—×–×§×”", right: "×—×–×§" }
];
toMaleMap.forEach(pair => {
clean = clean.replace(new RegExp(`\\b${pair.wrong}\\b`, 'g'), pair.right);
});
}
else if (state.recipientGender === 'female') {
const toFemaleMap = [
{ wrong: "×™×§×¨", right: "×™×§×¨×”" }, { wrong: "××”×•×‘", right: "××”×•×‘×”" },
{ wrong: "××“×”×™×", right: "××“×”×™××”" }, { wrong: "××§×¡×™×", right: "××§×¡×™××”" },
{ wrong: "××•×©×œ×", right: "××•×©×œ××ª" }, { wrong: "×”×˜×•×‘", right: "×”×˜×•×‘×”" },
{ wrong: "××ª×”", right: "××ª" }, { wrong: "× ×”×“×¨", right: "× ×”×“×¨×ª" },
{ wrong: "×—×©×•×‘", right: "×—×©×•×‘×”" }, { wrong: "××œ×š", right: "××œ×›×”" },
{ wrong: "××œ×•×£", right: "××œ×•×¤×”" }, { wrong: "×‘×¨×™×", right: "×‘×¨×™××”" },
{ wrong: "×—×–×§", right: "×—×–×§×”" }
];
toFemaleMap.forEach(pair => {
clean = clean.replace(new RegExp(`\\b${pair.wrong}\\b`, 'g'), pair.right);
});
}
}
return clean;
}

function generateBlessing() {
document.getElementsByName('length').forEach(l => { if(l.checked) state.length = l.value });
const output = document.getElementById('output');
let key = "";
let fallbackKey = null;

if (state.category === 'morning_evening') {
if (!state.timeOfDay || !state.subCategory) { alert("× × ×œ×‘×—×•×¨ ×–××Ÿ ×•×™×¢×“..."); return; }
key = `${state.timeOfDay}_${state.subCategory}`;
}
else if (state.category === 'shabbat') {
if (!state.shabbatTime || !state.subCategory) { alert("× × ×œ×‘×—×•×¨ ×–××Ÿ ×•×™×¢×“..."); return; }
key = `${state.shabbatTime}_${state.subCategory}`;
fallbackKey = `shabbat_${state.subCategory}`;
}
else if (state.category === 'holiday') {
if (!state.holidayName || !state.holidayTarget) { alert("× × ×œ×‘×—×•×¨ ×—×’ ×•×™×¢×“..."); return; }
key = `${state.holidayName}_${state.holidayTarget}`;
fallbackKey = `holiday_${state.holidayTarget}`; 
}
else if (state.category === 'chabad') {
if (!state.chabadDate || !state.chabadTarget) { alert("× × ×œ×‘×—×•×¨ ×ª××¨×™×š ×•×™×¢×“..."); return; }
key = `${state.chabadDate}_${state.chabadTarget}`;
}
else if (state.category === 'event') {
if (!state.subCategory) { alert("× × ×œ×‘×—×•×¨..."); return; }
key = state.subCategory;
}
else if (state.category === 'birth') {
if (!state.subCategory) { alert("× × ×œ×‘×—×•×¨ ×œ××™ × ×•×œ×“..."); return; }
key = `${state.birthType}_${state.subCategory}`;
fallbackKey = state.birthType;
}
else if (state.category === 'recovery') {
if (!state.subCategory) { alert("× × ×œ×‘×—×•×¨ ×œ××™..."); return; }
key = `recovery_${state.subCategory}`;
}
else if (state.category === 'thank_you') {
if (!state.subCategory) { alert("× × ×œ×‘×—×•×¨ ×œ××™..."); return; }
key = `thank_you_${state.subCategory}`;
}
else if (state.category === 'birthday') {
if (state.relationKey) {
key = `birthday_${state.relationKey}`;
} else {
const bdKey = (state.gender === 'woman' || state.gender === 'girl' || state.gender === 'female') ? 'birthday_female' : 'birthday_male';
key = bdKey;
}
}
else if (['success', 'love'].includes(state.category)) {
if (!state.gender) { alert("× × ×œ×‘×—×•×¨ ××™×Ÿ..."); return; }
key = `${state.category}_${state.gender}`;
}
else {
key = state.category;
}

let gen = generators[key];
if (!gen && localBlessings[key]) {
gen = localBlessings[key];
}

if (!gen && fallbackKey && generators[fallbackKey]) {
gen = generators[fallbackKey];
}

if (!gen) {
if (state.category === 'shabbat') gen = generators[`${state.shabbatTime}_general`];
else if (state.category === 'holiday') gen = generators[`${state.holidayName}_general`] || generators[`${state.holidayName}`];
else if (state.category === 'chabad') gen = generators[state.chabadDate];
else if (state.category === 'birthday') {
const fallbackKey = (state.gender === 'woman' || state.gender === 'girl') ? 'birthday_female' : 'birthday_male';
gen = generators[fallbackKey];
}
}

if (!gen) {
output.innerHTML = `<div style="color:red; text-align:center">×œ× × ××¦××• ×‘×¨×›×•×ª ×œ×§×˜×’×•×¨×™×”: ${key}</div>`;
return;
}

let parts = [];
const name = document.getElementById('nameInput').value.trim();
saveNameHistory(name);

if (name) {
let suffix = "×”×™×§×¨/×”";
const isWifeContext = (state.relationKey === 'wife' || state.relationKey === 'partner_female' || state.holidayTarget === 'wife' || state.subCategory === 'wife');
const isHusbandContext = (state.relationKey === 'husband' || state.relationKey === 'partner_male' || state.holidayTarget === 'husband' || state.subCategory === 'husband');

const isGenericFemale = (state.gender === 'woman' || state.gender === 'girl' || state.gender === 'female' || state.recipientGender === 'female');
const isGenericMale = (state.gender === 'man' || state.gender === 'boy' || state.gender === 'male' || state.recipientGender === 'male');

if (isWifeContext) {
suffix = wifeSuffixes[Math.floor(Math.random() * wifeSuffixes.length)];
} else if (isHusbandContext) {
suffix = husbandSuffixes[Math.floor(Math.random() * husbandSuffixes.length)];
} else {
if (isGenericFemale) suffix = "×”×™×§×¨×”";
else if (isGenericMale) suffix = "×”×™×§×¨";
}
parts.push(`${name} ${suffix},`);
}

parts.push(getDistinctRandom(gen.openers, 1)[0]);
const bodyCount = state.length === 'long' ? 2 : 1;
const bodies = getDistinctRandom(gen.bodies, bodyCount);
parts.push(...bodies);

if (state.category !== 'morning_evening') {
parts.push(getDistinctRandom(gen.closings, 1)[0]);
}

let adjustedParts = parts.map(part => smartGrammarFix(part));

let emojiSet = 'general';
if (state.category === 'morning_evening') emojiSet = state.timeOfDay;
else if (state.category === 'shabbat') emojiSet = state.shabbatTime;
else if (state.category === 'holiday') emojiSet = state.holidayName; 
else if (state.category === 'birth') emojiSet = state.birthType; 
else if (state.category === 'chabad') emojiSet = state.chabadDate;
else if (emojis[key]) emojiSet = key;
else if (emojis[state.category]) emojiSet = state.category;

if (state.category === 'chabad' && !emojis[emojiSet]) emojiSet = 'chabad';

renderLinesWithEmojis(adjustedParts, emojiSet);
}

function renderLinesWithEmojis(linesArray, setKey) {
const cleanLines = linesArray.filter(l => l && l.trim() !== "");
let availableEmojis = [...(emojis[setKey] || emojis['general'])];
const container = document.getElementById('output');
container.innerHTML = '';

cleanLines.forEach(line => {
let lineContent = line.trim();
if (state.useEmojis) {
if (availableEmojis.length === 0) availableEmojis = [...(emojis[setKey] || emojis['general'])];
const randomIndex = Math.floor(Math.random() * availableEmojis.length);
const emoji = availableEmojis[randomIndex];
availableEmojis.splice(randomIndex, 1);
lineContent = `${lineContent} ${emoji}`;
}
const row = document.createElement('div');
row.className = 'line-item';
row.innerHTML = `
<button class="delete-line-btn" onclick="this.parentElement.remove()" title="××—×§ ×©×•×¨×” ×–×•">âœ•</button>
<div class="line-text" contenteditable="true">*${lineContent}*</div>
`;
container.appendChild(row);
});
}

function getVisibleText() {
const rows = document.querySelectorAll('.line-text');
return Array.from(rows).map(r => r.innerText.trim()).join('\n');
}

function copyText() {
const textToCopy = getVisibleText();
if(!textToCopy) return;
navigator.clipboard.writeText(textToCopy);
const btn = document.querySelector('.btn-copy');
let old = btn.innerText; btn.innerText = "×”×•×¢×ª×§! ğŸ‘"; setTimeout(() => btn.innerText = old, 1500);
}

function sendWhatsapp() {
let text = getVisibleText();
if(!text) return alert("×§×•×“× ×¦×•×¨ ×‘×¨×›×”!");
window.open(`whatsapp://send?text=${encodeURIComponent(text)}`, '_blank');
}
</script>

</body>
</html>
