<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>××™×œ×™× ××”×œ×‘</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* --- CLAYMORPHISM STYLE (SOFT 3D) --- */
:root {
    --bg-body: #eef2f6;
    --clay-bg: #eef2f6;
    --primary: #4f46e5;
    --text-main: #4a5568;
    --text-sec: #718096;     
    --shadow-light: -8px -8px 16px 0px rgba(255, 255, 255, 0.8);
    --shadow-dark: 8px 8px 16px 0px rgba(166, 180, 200, 0.7);
    --shadow-inset: inset 6px 6px 10px 0 rgba(166, 180, 200, 0.7), inset -6px -6px 10px 0 rgba(255, 255, 255, 0.8);
    --radius: 24px;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    font-family: 'Rubik', sans-serif;
    background-color: var(--bg-body);
    color: var(--text-main);
    margin: 0;
    padding: 20px 15px;
    display: flex;
    justify-content: center;
    min-height: 100vh;
}

.container {
    width: 100%;
    max-width: 550px;
    background: var(--clay-bg);
    padding: 30px;
    border-radius: 30px;
    box-shadow: 
        10px 10px 20px rgba(166, 180, 200, 0.4),
        -10px -10px 20px rgba(255,255,255,0.8);
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: relative;
    min-height: 85vh;
    z-index: 1;
}

.header-row { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 10px;
    padding-bottom: 10px;
}

h1 { 
    font-size: 1.6rem; 
    margin: 0; 
    color: #2d3748; 
    font-weight: 700;
    letter-spacing: -0.5px;
    text-shadow: 2px 2px 4px rgba(166, 180, 200, 0.5);
}

.settings-btn { 
    background: var(--clay-bg);
    border: none;
    border-radius: 50%; 
    width: 36px;
    height: 36px;
    display: flex; align-items: center; justify-content: center;
    color: var(--text-sec);
    cursor: pointer;
    transition: 0.2s;
    font-size: 1rem;
    box-shadow: var(--shadow-dark), var(--shadow-light);
}
.settings-btn:active { box-shadow: var(--shadow-inset); transform: scale(0.95); }

.back-btn {
    background: var(--clay-bg);
    color: var(--text-main);
    border: none;
    padding: 12px;
    border-radius: var(--radius);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-dark), var(--shadow-light);
}
.back-btn:active { 
    box-shadow: var(--shadow-inset); 
    color: var(--primary);
    transform: scale(0.98);
}

.grid-container { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr);
    gap: 15px; 
}

/* --- ×›×¤×ª×•×¨×™× ×¨××©×™×™× --- */
.category-btn { 
    background: var(--clay-bg);
    border: none;
    padding: 16px 8px;
    border-radius: var(--radius);
    font-size: 0.85rem;
    cursor: pointer;
    font-weight: 600; 
    color: var(--text-main);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-dark), var(--shadow-light);
    position: relative;
}

.category-btn i {
    font-size: 1.5rem;
    color: #4a5568;
    margin-bottom: 2px;
    transition: 0.2s;
}

.category-btn[onclick*="morning_evening"] i { background: linear-gradient(to right, #ffd2a5, #ff8c42); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.category-btn[onclick*="shabbat"] i { background: linear-gradient(to right, #e0f7fa, #fffdd0, #d4af37); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.category-btn[onclick*="chabad"] i { background: linear-gradient(to right, #ffe29f, #ffd043); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.category-btn[onclick*="birthday"] i { background: linear-gradient(to right, #ffc3a0, #ffafbd, #c2e9fb, #e2ebf0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.category-btn[onclick*="love"] i { background: linear-gradient(to right, #ffafbd, #ff4b6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.category-btn[onclick*="birth"] i { background: linear-gradient(to right, #fff5e6, #f0d5a8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.category-btn[onclick*="recovery"] i { background: linear-gradient(to right, #ffcccb, #dc143c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.category-btn[onclick*="holiday"] i { background: linear-gradient(to right, #e6b8c3, #a8324e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.category-btn[onclick*="success"] i { background: linear-gradient(to right, #ffe7a1, #e6b800); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

.category-btn:hover { transform: translateY(-2px); }
.category-btn:active, .category-btn.active { box-shadow: var(--shadow-inset); color: var(--primary); transform: scale(0.97); }
.category-btn.active i, .category-btn:active i { transform: scale(0.95); }

.dynamic-section { display: none; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

.sub-grid, .holidays-grid { display: grid; gap: 12px; margin-top: 20px; }
.sub-grid { grid-template-columns: repeat(2, 1fr); }
.holidays-grid { grid-template-columns: repeat(3, 1fr); }

/* --- ×›×¤×ª×•×¨×™× ××©× ×™×™× --- */
.sub-btn { 
    background: var(--clay-bg);
    border: none;
    padding: 14px;
    border-radius: var(--radius);
    font-size: 0.9rem;
    cursor: pointer;
    color: var(--text-main);
    transition: all 0.2s ease;
    font-weight: 500;
    text-align: center;
    box-shadow: var(--shadow-dark), var(--shadow-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
}
.sub-btn:hover { transform: translateY(-2px); }
.sub-btn.active { box-shadow: var(--shadow-inset); color: var(--primary); font-weight: 700; }
.sub-btn.active i { -webkit-text-fill-color: transparent; }

/* --- ×¢×™×¦×•×‘ ××™×™×§×•× ×™× ××©× ×™×™× ×“×™× ××™ ×•×™×™×—×•×“×™ ×œ×›×œ ×§×˜×’×•×¨×™×” --- */
.sub-btn i {
    font-size: 1.2rem;
    margin-bottom: 2px;
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    color: transparent;
    background-image: linear-gradient(to right, #a1c4fd, #c2e9fb);
}

.sub-btn[onclick*="'morning'"] i { background-image: linear-gradient(to right, #ff9966, #ff5e62); } 
.sub-btn[onclick*="'noon'"] i { background-image: linear-gradient(to right, #56ccf2, #2f80ed); } 
.sub-btn[onclick*="'night'"] i { background-image: linear-gradient(to right, #232526, #414345); } 

.sub-btn[onclick*="'wedding'"] i, 
.sub-btn[onclick*="'henna'"] i,
.sub-btn[onclick*="'holiday'"] i { 
    background-image: linear-gradient(to right, #EC6F66, #F3A183); 
}

.sub-btn[onclick*="'shabbat'"] i,
.sub-btn[onclick*="'motzash'"] i {
    background-image: linear-gradient(to right, #bf953f, #fcf6ba, #b38728); 
}

.sub-btn[onclick*="chabad_19_kislev"] i { background-image: linear-gradient(to right, #DAA520, #FFD700); }
.sub-btn[onclick*="chabad_10_shevat"] i { background-image: linear-gradient(to right, #8E2DE2, #4A00E0); }
.sub-btn[onclick*="chabad_11_nissan"] i { background-image: linear-gradient(to right, #ff9a9e, #fecfef); }
.sub-btn[onclick*="chabad_3_tammuz"] i { background-image: linear-gradient(to right, #FF416C, #FF4B2B); }
.sub-btn[onclick*="chabad_12_tammuz"] i { background-image: linear-gradient(to right, #00c6ff, #0072ff); }
.sub-btn[onclick*="chabad_5_tevet"] i { background-image: linear-gradient(to right, #D1913C, #FFD194); }

.sub-btn[onclick*="'family'"] i,
.sub-btn[onclick*="'wife'"] i,
.sub-btn[onclick*="'husband'"] i,
.sub-btn[onclick*="'kids'"] i {
    background-image: linear-gradient(to right, #11998e, #38ef7d); 
}

/* ×¨×¤×•××” - ××“×•× */
#recoveryTargetSection .sub-btn i {
    background-image: linear-gradient(to right, #ffcccb, #dc143c);
}

/* ×ª×•×“×” - ×•×¨×“×¨×“ */
#thankYouTargetSection .sub-btn i {
    background-image: linear-gradient(to right, #fbc2eb, #a6c1ee);
}

h3 { font-size: 1.1rem; color: var(--text-sec); margin: 25px 0 15px; font-weight: 600; text-align: center; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; } 
h3 span { background: transparent; padding: 0 10px; }

.input-row { display: flex; gap: 12px; margin-bottom: 15px; }
input { width: 100%; padding: 18px; border: none; border-radius: var(--radius); font-size: 1rem; outline: none; transition: 0.2s; background: var(--clay-bg); font-family: 'Rubik', sans-serif; color: #2d3748; box-shadow: inset 4px 4px 8px rgba(166, 180, 200, 0.5), inset -4px -4px 8px rgba(255, 255, 255, 0.8); }
input:focus { box-shadow: inset 6px 6px 12px rgba(166, 180, 200, 0.6), inset -6px -6px 12px rgba(255, 255, 255, 0.9); }

.generate-btn { 
    background: var(--clay-bg); color: var(--primary); border: none; 
    padding: 16px; border-radius: var(--radius); 
    font-size: 1.1rem; font-weight: 700; cursor: pointer; box-shadow: 10px 10px 20px rgba(166, 180, 200, 0.6), -10px -10px 20px rgba(255, 255, 255, 0.9); 
    margin-top: 15px; /* ×”×•×§×˜×Ÿ ×-25 ×›×“×™ ×œ×§×¨×‘ */
    width: 100%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; 
}
.generate-btn:hover { transform: translateY(-2px); }
.generate-btn:active { box-shadow: var(--shadow-inset); transform: scale(0.98); }

/* ×©×•×¨×ª ×”×›×¤×ª×•×¨×™× ×”×××¦×¢×™×ª (××•×¨×š/××™××•×’'×™) - ×”×•×§×¨×‘×” */
.middle-controls { 
    display: flex; justify-content: center; align-items: center; gap: 15px; 
    margin-top: 10px; /* ×”×•×§×˜×Ÿ ×-15 */
    margin-bottom: 2px; /* ×”×•×§×˜×Ÿ ×-5 */
}

/* ××–×•×¨ ×”×¤×œ×˜ (×”×˜×‘×œ×”) - ×§×•×¨×‘ ×•×”×•×§×˜×Ÿ */
.output-container { 
    background: var(--clay-bg); 
    padding: 18px; /* ×”×•×§×˜×Ÿ ×-25 */
    border-radius: var(--radius); 
    min-height: 100px; 
    margin-top: 8px; /* ×”×•×§×˜×Ÿ ×-25 ×œ-8 ×›×“×™ ×œ×”×¦××™×“ */
    border: none; box-shadow: var(--shadow-inset); 
    font-size: 1.1rem; line-height: 1.7; 
}

.line-item { display: flex; align-items: center; margin-bottom: 12px; gap: 12px; background: var(--clay-bg); padding: 14px 18px; border-radius: 16px; box-shadow: 6px 6px 12px rgba(166, 180, 200, 0.4), -6px -6px 12px rgba(255, 255, 255, 0.8); border: none; }
.line-text { flex: 1; outline: none; color: #2d3748; }
.delete-line-btn { background: var(--clay-bg); color: #e53e3e; border: none; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: 0.2s; border-radius: 50%; box-shadow: 3px 3px 6px rgba(166, 180, 200, 0.4), -3px -3px 6px rgba(255, 255, 255, 0.8); }
.delete-line-btn:active { box-shadow: inset 2px 2px 5px rgba(166, 180, 200, 0.5), inset -2px -2px 5px #fff; }

.actions-bar { 
    display: flex; gap: 12px; 
    margin-top: 12px; /* ×”×•×§×˜×Ÿ ×-25 ×›×“×™ ×œ×§×¨×‘ ×œ×˜×‘×œ×” */
}
.action-btn { 
    flex: 1; padding: 14px; border: none; border-radius: var(--radius); 
    font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; background: var(--clay-bg); color: var(--text-main); box-shadow: var(--shadow-dark), var(--shadow-light); 
}
.action-btn:active { box-shadow: var(--shadow-inset); transform: scale(0.98); }
.btn-whatsapp { color: #047857; }
.btn-copy { color: #2d3748; }

.controls-area { background: var(--clay-bg); padding: 25px; border-radius: 30px; box-shadow: 0 -10px 20px rgba(255,255,255, 0.5); margin-top: auto; border: none; }
.favorites-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px; padding-bottom: 10px; border-bottom: 2px solid rgba(166, 180, 200, 0.2); }
.top-row { display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }

.toggle-group { background: var(--clay-bg); padding: 6px; border-radius: 50px; display: flex; gap: 8px; box-shadow: var(--shadow-inset); }
.toggle-btn { 
    border: none; background: transparent; 
    padding: 8px 16px; border-radius: 50px; cursor: pointer; 
    font-size: 0.85rem; color: var(--text-sec); font-weight: 500; transition: 0.2s; 
}
.toggle-btn.active { background: var(--clay-bg); color: var(--primary); box-shadow: 5px 5px 10px rgba(166, 180, 200, 0.5), -5px -5px 10px #fff; font-weight: 700; }
.toggle-btn input { display: none; }

.contact-rect { width: 100%; padding: 14px; border-radius: 18px; text-align: center; font-weight: 600; font-size: 0.9rem; color: var(--text-main); background: var(--clay-bg); cursor: pointer; transition: 0.2s; min-height: 55px; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-dark), var(--shadow-light); }
.contact-rect:active { box-shadow: var(--shadow-inset); transform: scale(0.97); }
.contact-rect.empty { box-shadow: var(--shadow-inset); color: #a0aec0 !important; }
.contact-label { font-size: 0.75rem; color: #a0aec0; text-align: center; margin-top: 6px; display: block; font-weight: 500;}

.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(226, 232, 240, 0.6); backdrop-filter: blur(8px); z-index: 9999; justify-content: center; align-items: center; }
.modal-content { background: var(--clay-bg); width: 90%; max-width: 450px; max-height: 85vh; overflow-y: auto; border-radius: 30px; padding: 0; box-shadow: 20px 20px 40px rgba(166, 180, 200, 0.5), -20px -20px 40px #fff; display: flex; flex-direction: column; animation: popIn 0.3s ease; }
.modal-header { padding: 25px; display: flex; justify-content: space-between; align-items: center; background: var(--clay-bg); position: sticky; top: 0; z-index: 10; border-bottom: 2px solid rgba(166, 180, 200, 0.2); }
.modal-body { padding: 25px; background: var(--clay-bg); }
.contact-card { background: var(--clay-bg); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 6px 6px 12px rgba(166, 180, 200, 0.4), -6px -6px 12px #fff; }
.card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.card-label { font-size: 0.85rem; font-weight: 700; color: #718096; background:transparent; padding:0; }
.input-with-icon input { background: var(--clay-bg); height: 48px; font-size: 0.95rem; box-shadow: inset 3px 3px 6px rgba(166, 180, 200, 0.5), inset -3px -3px 6px #fff; border-radius: 12px; }
.input-with-icon i { right: 15px; color: #a0aec0; }
.import-btn { 
    width: 100%; background: var(--clay-bg); color: var(--primary); border: none; 
    padding: 12px; border-radius: 15px; 
    font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 20px; transition: 0.2s; box-shadow: 5px 5px 10px rgba(166, 180, 200, 0.4), -5px -5px 10px #fff; 
}
.import-btn:active { box-shadow: inset 3px 3px 6px rgba(166, 180, 200, 0.5), inset -3px -3px 6px #fff; }
.save-settings-btn { 
    background: var(--clay-bg); color: var(--primary); border-radius: 15px; 
    padding: 14px; width: 100%; border: none; 
    font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s; margin-top: 20px; box-shadow: 6px 6px 12px rgba(166, 180, 200, 0.5), -6px -6px 12px #fff; 
}
.save-settings-btn:active { box-shadow: inset 3px 3px 6px rgba(166, 180, 200, 0.5), inset -3px -3px 6px #fff; }
#loadingOverlay { background: rgba(238, 242, 246, 0.9); z-index: 999; backdrop-filter: blur(5px); }
.spinner { border: 4px solid #cbd5e0; border-top: 4px solid var(--primary); width: 40px; height: 40px; border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="container">
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <span class="loading-text">×˜×•×¢×Ÿ...</span>
    </div>

    <div class="header-row">
        <div style="width:40px"></div> <h1>××™×œ×™× ××”×œ×‘</h1>
        <button class="settings-btn" onclick="openSettings()" title="×”×’×“×¨×•×ª">
            <i class="fa-solid fa-gear"></i>
        </button>
    </div>

    <button class="back-btn" id="backBtn" onclick="goBack()">
        <i class="fa-solid fa-arrow-right"></i> ×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™
    </button>

    <div class="grid-container" id="mainGrid">
        <button class="category-btn" onclick="selectCategory('morning_evening', this)">
            <i class="fa-solid fa-sun"></i>
            ×‘×•×§×¨/×¢×¨×‘
        </button>
        <button class="category-btn" onclick="selectCategory('shabbat', this)">
            <i class="fa-solid fa-menorah"></i> ×©×‘×ª
        </button>
        <button class="category-btn" onclick="selectCategory('holiday', this)">
            <i class="fa-solid fa-wine-glass"></i>
            ×—×’×™×
        </button>
        <button class="category-btn" onclick="selectCategory('chabad', this)">
            <i class="fa-solid fa-crown"></i>
            ×—×‘"×“
        </button>
        <button class="category-btn" onclick="selectCategory('birthday', this)">
            <i class="fa-solid fa-cake-candles"></i>
            ×™×•× ×”×•×œ×“×ª
        </button>
        <button class="category-btn" onclick="selectCategory('event', this)">
            <i class="fa-solid fa-ring"></i>
            ××™×¨×•×¢
        </button>
        <button class="category-btn" onclick="selectCategory('birth', this)">
            <i class="fa-solid fa-baby-carriage"></i>
            ×œ×™×“×”
        </button>
        <button class="category-btn" onclick="selectCategory('recovery', this)">
            <i class="fa-solid fa-heart-pulse"></i>
            ×¨×¤×•××”
        </button>
        <button class="category-btn" onclick="selectCategory('thank_you', this)">
            <i class="fa-solid fa-hands-praying"></i>
            ×ª×•×“×”
        </button>
        <button class="category-btn" onclick="selectCategory('success', this)">
            <i class="fa-solid fa-trophy"></i>
            ×”×¦×œ×—×”
        </button>
        <button class="category-btn" onclick="selectCategory('love', this)">
            <i class="fa-solid fa-heart"></i>
            ××”×‘×”
        </button>
    </div>

    <div id="morningEveningSection" class="dynamic-section">
        <div id="timeOfDaySelector">
            <h3><span>××” ×”×©×¢×”?</span></h3>
            <div class="sub-grid" style="grid-template-columns: repeat(3, 1fr);">
                <button class="sub-btn" onclick="selectTimeOfDay('morning', this)"><i class="fa-regular fa-sun"></i> ×‘×•×§×¨</button>
                <button class="sub-btn" onclick="selectTimeOfDay('noon', this)"><i class="fa-solid fa-cloud-sun"></i> ×¦×”×¨×™×™×</button>
                <button class="sub-btn" onclick="selectTimeOfDay('night', this)"><i class="fa-solid fa-moon"></i> ×œ×™×œ×”</button>
            </div>
        </div>
        <div id="timeTargetSelector" style="display:none; margin-top:15px;">
            <h3><span>×œ××™ ×”×‘×¨×›×”?</span></h3>
            <div class="sub-grid">
                <button class="sub-btn" onclick="selectTimeTarget('general', this)"><i class="fa-regular fa-star"></i> ×›×œ×œ×™</button>
                <button class="sub-btn" onclick="selectTimeTarget('husband', this)"><i class="fa-solid fa-user-tie"></i> ×œ×‘×¢×œ×™</button>
                <button class="sub-btn" onclick="selectTimeTarget('wife', this)"><i class="fa-solid fa-person-dress"></i> ×œ××©×ª×™</button>
            </div>
        </div>
    </div>

    <div id="shabbatSection" class="dynamic-section">
        <div id="shabbatTimeSelector">
            <h3><span>×–××Ÿ</span></h3>
            <div class="sub-grid">
                <button class="sub-btn" onclick="selectShabbatTime('shabbat')"><i class="fa-regular fa-hourglass-half"></i> ×œ×§×¨××ª ×©×‘×ª</button>
                <button class="sub-btn" onclick="selectShabbatTime('motzash')"><i class="fa-solid fa-star-and-crescent"></i> ××•×¦××™ ×©×‘×ª</button>
            </div>
        </div>
        <div id="shabbatTargetSelector" style="display:none;">
            <h3 id="shabbatTargetTitle"><span>×œ××™ ×”×‘×¨×›×”?</span></h3>
            <div class="sub-grid">
                <button class="sub-btn" onclick="selectSub('general', this)"><i class="fa-regular fa-star"></i> ×›×œ×œ×™</button>
                <button class="sub-btn" onclick="selectSub('family', this)"><i class="fa-solid fa-people-roof"></i> ××©×¤×—×”</button>
                <button class="sub-btn" onclick="selectSub('wife', this)"><i class="fa-solid fa-person-dress"></i> ××©×ª×™</button>
                <button class="sub-btn" onclick="selectSub('husband', this)"><i class="fa-solid fa-user-tie"></i> ×‘×¢×œ×™</button>
                <button class="sub-btn" onclick="selectSub('parents', this)"><i class="fa-solid fa-user-group"></i> ×”×•×¨×™×</button>
                <button class="sub-btn" onclick="selectSub('kids', this)"><i class="fa-solid fa-children"></i> ×™×œ×“×™×</button>
                <button class="sub-btn" onclick="selectSub('brother', this)"><i class="fa-solid fa-user"></i> ××—</button>
                <button class="sub-btn" onclick="selectSub('sister', this)"><i class="fa-solid fa-user"></i> ××—×•×ª</button>
                <button class="sub-btn" onclick="selectSub('friend_male', this)"><i class="fa-solid fa-user-group"></i> ×—×‘×¨</button>
                <button class="sub-btn" onclick="selectSub('friend_female', this)"><i class="fa-solid fa-user-group"></i> ×—×‘×¨×”</button>
            </div>
        </div>
    </div>

    <div id="holidaySection" class="dynamic-section">
        <div id="holidayNameSelector">
            <h3><span>×‘×—×¨ ×—×’</span></h3>
            <div class="holidays-grid">
                <button class="sub-btn" onclick="selectHolidayName('rosh_chodesh', this)"><i class="fa-regular fa-moon"></i> ×¨××© ×—×•×“×©</button>
                <button class="sub-btn" onclick="selectHolidayName('rosh_hashanah', this)"><i class="fa-solid fa-apple-whole"></i> ×¨"×”×©× ×”</button>
                <button class="sub-btn" onclick="selectHolidayName('yom_kippur', this)"><i class="fa-solid fa-scale-balanced"></i> ×›×™×¤×•×¨</button>
                <button class="sub-btn" onclick="selectHolidayName('sukkot', this)"><i class="fa-solid fa-campground"></i> ×¡×•×›×•×ª</button>
                <button class="sub-btn" onclick="selectHolidayName('simchat_torah', this)"><i class="fa-solid fa-scroll"></i> ×©××—×ª ×ª×•×¨×”</button>
                <button class="sub-btn" onclick="selectHolidayName('hanukkah', this)"><i class="fa-solid fa-menorah"></i> ×—× ×•×›×”</button>
                <button class="sub-btn" onclick="selectHolidayName('tu_bishvat', this)"><i class="fa-solid fa-tree"></i> ×˜"×• ×‘×©×‘×˜</button>
                <button class="sub-btn" onclick="selectHolidayName('purim', this)"><i class="fa-solid fa-masks-theater"></i> ×¤×•×¨×™×</button>
                <button class="sub-btn" onclick="selectHolidayName('passover', this)"><i class="fa-solid fa-wine-glass"></i> ×¤×¡×—</button>
                <button class="sub-btn" onclick="selectHolidayName('mimouna', this)"><i class="fa-solid fa-cookie-bite"></i> ××™××•× ×”</button>
                <button class="sub-btn" onclick="selectHolidayName('yom_haatzmaut', this)"><i class="fa-solid fa-flag"></i> ×”×¢×¦×××•×ª</button>
                <button class="sub-btn" onclick="selectHolidayName('lag_baomer', this)"><i class="fa-solid fa-fire"></i> ×œ"×’ ×‘×¢×•××¨</button>
                <button class="sub-btn" onclick="selectHolidayName('shavuot', this)"><i class="fa-solid fa-wheat-awn"></i> ×©×‘×•×¢×•×ª</button>
                <button class="sub-btn" onclick="selectHolidayName('tu_beav', this)"><i class="fa-solid fa-heart"></i> ×˜"×• ×‘××‘</button>
                <button class="sub-btn" onclick="selectHolidayName('generic_holiday', this)"><i class="fa-solid fa-calendar-check"></i> ×›×œ×œ×™</button>
            </div>
        </div>
        <div id="holidayTargetSelector" style="display:none; margin-top:15px;">
            <h3><span>×œ××™ ×©×•×œ×—×™×?</span></h3>
            <div class="sub-grid">
                <button class="sub-btn" onclick="selectHolidayTarget('general', this)"><i class="fa-regular fa-star"></i> ×›×œ×œ×™</button>
                <button class="sub-btn" onclick="selectHolidayTarget('family', this)"><i class="fa-solid fa-people-roof"></i> ××©×¤×—×”</button>
                <button class="sub-btn" onclick="selectHolidayTarget('wife', this)"><i class="fa-solid fa-person-dress"></i> ××©×ª×™</button>
                <button class="sub-btn" onclick="selectHolidayTarget('husband', this)"><i class="fa-solid fa-user-tie"></i> ×‘×¢×œ×™</button>
                <button class="sub-btn" onclick="selectHolidayTarget('parents', this)"><i class="fa-solid fa-user-group"></i> ×”×•×¨×™×</button>
                <button class="sub-btn" onclick="selectHolidayTarget('kids', this)"><i class="fa-solid fa-children"></i> ×™×œ×“×™×</button>
                <button class="sub-btn" onclick="selectHolidayTarget('brother', this)"><i class="fa-solid fa-user"></i> ××—</button>
                <button class="sub-btn" onclick="selectHolidayTarget('sister', this)"><i class="fa-solid fa-user"></i> ××—×•×ª</button>
                <button class="sub-btn" onclick="selectHolidayTarget('friend_male', this)"><i class="fa-solid fa-user-group"></i> ×—×‘×¨</button>
                <button class="sub-btn" onclick="selectHolidayTarget('friend_female', this)"><i class="fa-solid fa-user-group"></i> ×—×‘×¨×”</button>
            </div>
        </div>
    </div>

    <div id="chabadSection" class="dynamic-section">
        <h3><span>×ª××¨×™×š ×—×¡×™×“×™</span></h3>
        <div class="holidays-grid">
            <button class="sub-btn" onclick="selectSub('chabad_19_kislev', this)"><i class="fa-solid fa-crown"></i> ×™"×˜ ×›×¡×œ×•</button>
            <button class="sub-btn" onclick="selectSub('chabad_10_shevat', this)"><i class="fa-solid fa-user-tie"></i> ×™' ×©×‘×˜</button>
            <button class="sub-btn" onclick="selectSub('chabad_11_nissan', this)"><i class="fa-solid fa-cake-candles"></i> ×™"× × ×™×¡×Ÿ</button>
            <button class="sub-btn" onclick="selectSub('chabad_3_tammuz', this)"><i class="fa-solid fa-fire-flame-simple"></i> ×’' ×ª××•×–</button>
            <button class="sub-btn" onclick="selectSub('chabad_12_tammuz', this)"><i class="fa-solid fa-lock-open"></i> ×™"×‘ ×ª××•×–</button>
            <button class="sub-btn" onclick="selectSub('chabad_18_elul', this)"><i class="fa-solid fa-star"></i> ×—"×™ ××œ×•×œ</button>
            <button class="sub-btn" onclick="selectSub('chabad_5_tevet', this)"><i class="fa-solid fa-book"></i> ×”' ×˜×‘×ª</button>
            <button class="sub-btn" onclick="selectSub('chabad_22_shevat', this)"><i class="fa-solid fa-person-dress"></i> ×›"×‘ ×©×‘×˜</button>
            <button class="sub-btn" onclick="selectSub('chabad_24_tevet', this)"><i class="fa-solid fa-scroll"></i> ×›"×“ ×˜×‘×ª</button>
            <button class="sub-btn" onclick="selectSub('chabad_14_kislev', this)"><i class="fa-solid fa-heart"></i> ×™"×“ ×›×¡×œ×•</button>
            <button class="sub-btn" onclick="selectSub('chabad_2_iyar', this)"><i class="fa-solid fa-bullhorn"></i> ×‘' ××™×™×¨</button>
            <button class="sub-btn" onclick="selectSub('chabad_6_tishrei', this)"><i class="fa-solid fa-book-open"></i> ×•' ×ª×©×¨×™</button>
        </div>
        <h3 style="margin-top:15px;"><span>×œ××™?</span></h3>
        <div class="sub-grid">
            <button class="sub-btn" onclick="selectSub('general', this)"><i class="fa-regular fa-star"></i> ×›×œ×œ×™</button>
            <button class="sub-btn" onclick="selectSub('family', this)"><i class="fa-solid fa-people-roof"></i> ××©×¤×—×”</button>
        </div>
    </div>

    <div id="eventSection" class="dynamic-section">
        <h3><span>××™×¨×•×¢</span></h3>
        <div class="sub-grid">
            <button class="sub-btn" onclick="selectSub('wedding', this)"><i class="fa-solid fa-ring"></i> ×—×ª×•× ×”</button>
            <button class="sub-btn" onclick="selectSub('bar_mitzvah', this)"><i class="fa-solid fa-scroll"></i> ×‘×¨ ××¦×•×•×”</button>
            <button class="sub-btn" onclick="selectSub('bat_mitzvah', this)"><i class="fa-solid fa-star-of-david"></i> ×‘×ª ××¦×•×•×”</button>
            <button class="sub-btn" onclick="selectSub('brit_milah', this)"><i class="fa-solid fa-baby"></i> ×‘×¨×™×ª ××™×œ×”</button>
            <button class="sub-btn" onclick="selectSub('brita', this)"><i class="fa-solid fa-baby-carriage"></i> ×‘×¨×™×ª×”</button>
            <button class="sub-btn" onclick="selectSub('housewarming', this)"><i class="fa-solid fa-house-chimney"></i> ×—× ×•×›×ª ×‘×™×ª</button>
            <button class="sub-btn" onclick="selectSub('henna', this)"><i class="fa-solid fa-hand-sparkles"></i> ×—×™× ×”</button>
        </div>
    </div>

    <div id="birthSection" class="dynamic-section">
        <h3><span>××–×œ ×˜×•×‘!</span></h3>
        <div class="sub-grid">
            <button class="sub-btn" onclick="selectBirthType('birth_boy')"><i class="fa-solid fa-child-reaching"></i> ×‘×Ÿ</button>
            <button class="sub-btn" onclick="selectBirthType('birth_girl')"><i class="fa-solid fa-child-dress"></i> ×‘×ª</button>
        </div>
        <div id="birthSubTargetSection" style="display:none; margin-top:15px;">
            <h3 id="birthTargetTitle"><span>×œ××™ × ×•×œ×“?</span></h3>
            <div class="sub-grid" id="birthTargetButtons"></div>
        </div>
    </div>

    <div id="recoveryTargetSection" class="dynamic-section">
        <h3><span>×”×—×œ××” ××”×™×¨×”</span></h3>
        <span class="section-title" style="display:block; text-align:center; font-size:0.9rem; color:#888; margin-bottom:5px;">×’×‘×¨×™×</span>
        <div class="sub-grid">
            <button class="sub-btn" onclick="selectRecoveryTarget('male', this)"><i class="fa-solid fa-user"></i> ×’×‘×¨ ×›×œ×œ×™</button>
            <button class="sub-btn" onclick="selectRecoveryTarget('dad', this)"><i class="fa-solid fa-user-tie"></i> ××‘×</button>
            <button class="sub-btn" onclick="selectRecoveryTarget('brother', this)"><i class="fa-solid fa-user"></i> ××—</button>
            <button class="sub-btn" onclick="selectRecoveryTarget('son', this)"><i class="fa-solid fa-child"></i> ×‘×Ÿ</button>
            <button class="sub-btn" onclick="selectRecoveryTarget('friend_male', this)"><i class="fa-solid fa-user-group"></i> ×—×‘×¨</button>
        </div>
        <span class="section-title" style="display:block; text-align:center; font-size:0.9rem; color:#888; margin-bottom:5px;">× ×©×™×</span>
        <div class="sub-grid">
            <button class="sub-btn" onclick="selectRecoveryTarget('female', this)"><i class="fa-solid fa-person-dress"></i> ××™×©×” ×›×œ×œ×™×ª</button>
            <button class="sub-btn" onclick="selectRecoveryTarget('mom', this)"><i class="fa-solid fa-person-breastfeeding"></i> ×××</button>
            <button class="sub-btn" onclick="selectRecoveryTarget('sister', this)"><i class="fa-solid fa-person-dress"></i> ××—×•×ª</button>
            <button class="sub-btn" onclick="selectRecoveryTarget('daughter', this)"><i class="fa-solid fa-child-dress"></i> ×‘×ª</button>
            <button class="sub-btn" onclick="selectRecoveryTarget('friend_female', this)"><i class="fa-solid fa-user-group"></i> ×—×‘×¨×”</button>
        </div>
    </div>

    <div id="thankYouTargetSection" class="dynamic-section">
        <h3><span>×ª×•×“×”</span></h3>
        <div class="sub-grid" style="grid-template-columns: repeat(2, 1fr);">
            <button class="sub-btn" onclick="selectThankYouTarget('male_general', this)"><i class="fa-solid fa-user"></i> ×’×‘×¨ ×›×œ×œ×™</button>
            <button class="sub-btn" onclick="selectThankYouTarget('father', this)"><i class="fa-solid fa-user-tie"></i> ××‘×</button>
            <button class="sub-btn" onclick="selectThankYouTarget('brother', this)"><i class="fa-solid fa-user"></i> ××—</button>
            <button class="sub-btn" onclick="selectThankYouTarget('friend_male', this)"><i class="fa-solid fa-user-group"></i> ×—×‘×¨</button>
            <button class="sub-btn" onclick="selectThankYouTarget('female_general', this)"><i class="fa-solid fa-person-dress"></i> ××™×©×” ×›×œ×œ×™×ª</button>
            <button class="sub-btn" onclick="selectThankYouTarget('mother', this)"><i class="fa-solid fa-person-breastfeeding"></i> ×××</button>
            <button class="sub-btn" onclick="selectThankYouTarget('sister', this)"><i class="fa-solid fa-person-dress"></i> ××—×•×ª</button>
            <button class="sub-btn" onclick="selectThankYouTarget('friend_female', this)"><i class="fa-solid fa-user-group"></i> ×—×‘×¨×”</button>
        </div>
    </div>

    <div id="genderSection" class="dynamic-section">
        <h3><span>××’×“×¨</span></h3>
        <div class="sub-grid">
            <button class="sub-btn" onclick="selectGenderGeneral('male', this)"><i class="fa-solid fa-mars"></i> ×’×‘×¨</button>
            <button class="sub-btn" onclick="selectGenderGeneral('female', this)"><i class="fa-solid fa-venus"></i> ××™×©×”</button>
        </div>
    </div>

    <div id="birthdaySection" class="dynamic-section">
        <h3><span>×™×•× ×”×•×œ×“×ª ×œ...</span></h3>
        <div class="sub-grid" style="grid-template-columns: repeat(4, 1fr);">
            <button class="sub-btn" onclick="selectGender('man', this)"><i class="fa-solid fa-user-tie"></i> ×’×‘×¨</button>
            <button class="sub-btn" onclick="selectGender('woman', this)"><i class="fa-solid fa-person-dress"></i> ××™×©×”</button>
            <button class="sub-btn" onclick="selectGender('boy', this)"><i class="fa-solid fa-child"></i> ×™×œ×“</button>
            <button class="sub-btn" onclick="selectGender('girl', this)"><i class="fa-solid fa-child-dress"></i> ×™×œ×“×”</button>
        </div>
        <div id="relationsContainer" style="display:none; margin-top:10px;">
            <div class="sub-grid" id="relationsGrid" style="grid-template-columns: repeat(3, 1fr);"></div>
        </div>
    </div>

    <div id="inputSection" class="dynamic-section" style="display:none;">
        <div class="input-row">
            <input type="text" id="nameInput" placeholder="×©× ××§×‘×œ/×ª ×”×‘×¨×›×”" list="nameHistory">
            <datalist id="nameHistory"></datalist>
            <input type="number" id="ageInput" placeholder="×’×™×œ (××•×¤×¦×™×•× ×œ×™)">
        </div>
    </div>

    <button class="generate-btn" id="genBtn" onclick="generateBlessing()" style="display:none;">
        <i class="fa-solid fa-wand-magic-sparkles"></i> ×¦×•×¨ ×‘×¨×›×”
    </button>
    
    <div class="middle-controls" id="optionsRow" style="display:none;">
        <div class="toggle-group">
            <label class="toggle-btn active" id="lenLong"><input type="radio" name="length" value="long" onchange="setLengthUI('long')" checked>××¨×•×›×”</label>
            <label class="toggle-btn" id="lenShort"><input type="radio" name="length" value="short" onchange="setLengthUI('short')">×§×¦×¨×”</label>
        </div>

        <button class="toggle-btn active" id="emojiBtn" onclick="toggleEmoji()" style="border:1px solid #e2e8f0;">
            <span id="emojiIcon">âœ…</span> ××™××•×’'×™
        </button>
    </div>

    <div class="output-container" id="output">
        <div style="opacity:0.5; text-align:center; padding-top:10px;">
            <i class="fa-regular fa-comment-dots" style="font-size:2rem; margin-bottom:10px; display:block;"></i>
            ×”×‘×¨×›×” ×ª×•×¤×™×¢ ×›××Ÿ...
        </div>
    </div>

    <div class="actions-bar">
        <button class="action-btn btn-copy" onclick="copyText()">
            <i class="fa-regular fa-copy"></i> ×”×¢×ª×§
        </button>
        <button class="action-btn btn-whatsapp" onclick="sendWhatsapp()">
            <i class="fa-brands fa-whatsapp"></i> ×©×œ×—
        </button>
    </div>

    <div class="controls-area">
        <div class="favorites-bar"></div>

        <div class="top-row">
            <div class="toggle-group">
                <button class="toggle-btn active" id="senderMale" onclick="setSenderGender('male')">×× ×™ ×’×‘×¨ ğŸ‘¨</button>
                <button class="toggle-btn" id="senderFemale" onclick="setSenderGender('female')">×× ×™ ××™×©×” ğŸ‘©</button>
            </div>
        </div>
    </div>

</div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="margin:0; font-size:1.3rem; font-weight:700;">×”×’×“×¨×ª ×× ×©×™ ×§×©×¨</h2>
            <button class="close-modal" onclick="closeSettings()" style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:#64748b; padding:5px;">âœ•</button>
        </div>
        <div class="modal-body">
            <div id="settingsRows"></div>
            <button class="save-settings-btn" onclick="saveSettings()">×©××•×¨ ×©×™× ×•×™×™×</button>
        </div>
    </div>
</div>

<script>
let generators = {};
let state = {
category: null,
subCategory: null,
shabbatTime: null,
holidayName: null,
holidayTarget: null,
chabadDate: null,
chabadTarget: null,
timeOfDay: null,
length: 'long',
gender: null,
recipientGender: null,
relationKey: null,
birthType: null,
useEmojis: true,
senderGender: 'male'
};

let contacts = [
{ name: '', phone: '', color: '#e2e8f0' },
{ name: '', phone: '', color: '#e2e8f0' },
{ name: '', phone: '', color: '#e2e8f0' },
{ name: '', phone: '', color: '#e2e8f0' },
{ name: '', phone: '', color: '#e2e8f0' },
{ name: '', phone: '', color: '#e2e8f0' }
];

const localBlessings = {
"birthday_partner_female": {
"openers": ["×‘×ª ×”×–×•×’ ×”××”×•×‘×”,", "×™×§×™×¨×ª×™,", "××”×‘×ª ×—×™×™,", "×”× ×¡×™×›×” ×©×œ×™,"],
"bodies": ["××™×Ÿ ××™×œ×™× ×œ×ª××¨ ×›××” ××ª ×—×©×•×‘×” ×œ×™.", "×××—×œ ×œ×š ×©×›×œ ×™×•× ×™×”×™×” ×™×¤×” ×•×–×•×”×¨ ×›××• ×”×—×™×•×š ×©×œ×š."],
"closings": ["××•×”×‘ ××•×ª×š.", "×©×œ×š ×ª××™×“."]
}
};
const wifeSuffixes = ["×”××•×©×œ××ª", "×”×™×¤×” ×©×œ×™", "××”×‘×ª ×—×™×™", "××œ×›×ª×™"];
const husbandSuffixes = ["×”××•×©×œ×", "×”×’×‘×¨ ×©×œ×™", "××”×‘×ª ×—×™×™", "××œ×š ×”×¢×•×œ×"];

const jsonFiles = [
"https://raw.githubusercontent.com/Yossi65/berkot/refs/heads/main/(%D7%91%D7%95%D7%A7%D7%A8%2C%20%D7%A6%D7%94%D7%A8%D7%99%D7%99%D7%9D%2C%20%D7%A2%D7%A8%D7%91).json",
"https://raw.githubusercontent.com/Yossi65/berkot/refs/heads/main/%D7%90%D7%99%D7%A8%D7%95%D7%A2.json",
"https://raw.githubusercontent.com/Yossi65/berkot/refs/heads/main/%D7%94%D7%A6%D7%9C%D7%97%D7%94%20.json",
"https://raw.githubusercontent.com/Yossi65/berkot/refs/heads/main/%D7%97%D7%91%D7%93.json",
"https://raw.githubusercontent.com/Yossi65/berkot/a115f2dacee968e59cce722dd783844c8b0eac7f/%D7%97%D7%92.json",
"https://raw.githubusercontent.com/Yossi65/berkot/refs/heads/main/%D7%99%D7%95%D7%9D%20%D7%94%D7%95%D7%9C%D7%93%D7%AA%20.json",
"https://raw.githubusercontent.com/Yossi65/berkot/refs/heads/main/%D7%9C%D7%90%D7%94%D7%91%D7%94.json",
"https://raw.githubusercontent.com/Yossi65/berkot/a115f2dacee968e59cce722dd783844c8b0eac7f/%D7%9C%D7%99%D7%93%D7%94.json",
"https://raw.githubusercontent.com/Yossi65/berkot/a115f2dacee968e59cce722dd783844c8b0eac7f/%D7%A8%D7%A4%D7%95%D7%90%D7%94.json",
"https://raw.githubusercontent.com/Yossi65/berkot/a115f2dacee968e59cce722dd783844c8b0eac7f/%D7%A9%D7%91%D7%AA%20%D7%95%D7%9E%D7%95%D7%A6%D7%90%D7%99%20%D7%A9%D7%91%D7%AA.json",
"https://raw.githubusercontent.com/Yossi65/berkot/a115f2dacee968e59cce722dd783844c8b0eac7f/%D7%AA%D7%95%D7%93%D7%94.json"
];

window.onload = function() {
const savedSender = localStorage.getItem('senderGender') || 'male';
setSenderGender(savedSender);

const savedEmojiState = localStorage.getItem('useEmojis');
if (savedEmojiState !== null) {
state.useEmojis = (savedEmojiState === 'true');
}
updateEmojiUI();

const savedLength = localStorage.getItem('blessingLength');
if (savedLength) {
setLengthUI(savedLength);
}
loadAllBlessings();
loadNameHistory();
loadContacts();
renderContactButtons();
};

function setLengthUI(len) {
    state.length = len;
    localStorage.setItem('blessingLength', len);
    document.querySelectorAll('input[name="length"]').forEach(el => {
        if(el.value === len) el.checked = true;
    });
    document.getElementById('lenLong').classList.remove('active');
    document.getElementById('lenShort').classList.remove('active');
    if(len === 'long') document.getElementById('lenLong').classList.add('active');
    else document.getElementById('lenShort').classList.add('active');
}

function loadContacts() {
const saved = localStorage.getItem('myContacts_v5');
if (saved) {
try {
let temp = JSON.parse(saved);
if(Array.isArray(temp)) {
contacts = temp;
while(contacts.length < 6) contacts.push({name:'', phone:'', color:'#e2e8f0'});
if(contacts.length > 6) contacts = contacts.slice(0,6);
}
} catch(e) { console.error(e); }
}
}

function renderContactButtons() {
const container = document.querySelector('.favorites-bar');
container.innerHTML = '';
contacts.forEach((contact, index) => {
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex'; 
    wrapper.style.flexDirection = 'column'; 
    wrapper.style.alignItems = 'center';
    
    const btn = document.createElement('div');
    if (contact.phone) {
        btn.className = 'contact-rect';
        btn.style.color = '#334155';
        btn.innerText = contact.name || `××™×© ×§×©×¨ ${index+1}`;
        btn.onclick = () => sendToContact(index);
    } else {
        btn.className = 'contact-rect empty';
        btn.innerText = '+';
        btn.onclick = () => openSettings();
    }
    
    const label = document.createElement('span');
    label.className = 'contact-label';
    label.innerText = `××™×© ×§×©×¨ ${index + 1}`;
    
    wrapper.appendChild(btn);
    wrapper.appendChild(label);
    container.appendChild(wrapper);
});
}

function sendToContact(index) {
const contact = contacts[index];
if (!contact.phone) { openSettings(); return; }
let text = getVisibleText();
if(!text) { alert("×§×•×“× ×›×œ ×¦×•×¨ ×‘×¨×›×”!"); return; }
let cleanPhone = contact.phone.replace(/\D/g, '');
if (cleanPhone.startsWith('0')) cleanPhone = '972' + cleanPhone.substring(1);
window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(text)}`, '_blank');
}

/* ×¤×•× ×§×¦×™×™×ª ×¤×ª×™×—×ª ×”×’×“×¨×•×ª ××¢×•×“×›× ×ª ×¢× ×¢×™×¦×•×‘ ×—×“×© */
function openSettings() {
const container = document.getElementById('settingsRows');
container.innerHTML = '';
contacts.forEach((contact, index) => {
const card = document.createElement('div');
card.className = 'contact-card';
card.innerHTML = `
<div class="card-top">
    <div class="card-label">××™×© ×§×©×¨ ${index + 1}</div>
</div>
<div class="contact-inputs">
    <div class="input-with-icon">
        <input type="text" id="name${index}" placeholder="×©× ×©×™×•×¤×™×¢ ×‘×›×¤×ª×•×¨" value="${contact.name}">
        <i class="fa-regular fa-user"></i>
    </div>
    <div class="input-with-icon">
        <input type="tel" id="phone${index}" placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ (×•×•××˜×¡××¤)" value="${contact.phone}">
        <i class="fa-brands fa-whatsapp"></i>
    </div>
</div>
<button class="import-btn" onclick="pickContact(${index})">
    <i class="fa-regular fa-address-book"></i> ×™×™×‘× ××× ×©×™ ×”×§×©×¨
</button>
`;
container.appendChild(card);
});
document.getElementById('settingsModal').style.display = 'flex';
}

async function pickContact(index) {
const isSupported = ('contacts' in navigator && 'ContactsManager' in window);
if (!isSupported) {
alert("×“×¤×“×¤×Ÿ ×–×” ××™× ×• ×ª×•××š ×‘×™×™×‘×•× ×™×©×™×¨. × × ×œ×”×–×™×Ÿ ×™×“× ×™×ª.");
return;
}
try {
const props = ['name', 'tel'];
const opts = { multiple: false };
const contactsSelected = await navigator.contacts.select(props, opts);
if (contactsSelected && contactsSelected.length > 0) {
const contact = contactsSelected[0];
if (contact.name && contact.name.length > 0) document.getElementById(`name${index}`).value = contact.name[0];
if (contact.tel && contact.tel.length > 0) document.getElementById(`phone${index}`).value = contact.tel[0];
}
} catch (ex) { console.log(ex); }
}

function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
function saveSettings() {
contacts.forEach((contact, index) => {
const nameEl = document.getElementById(`name${index}`);
const phoneEl = document.getElementById(`phone${index}`);
if(nameEl) contact.name = nameEl.value;
if(phoneEl) contact.phone = phoneEl.value;
});
localStorage.setItem('myContacts_v5', JSON.stringify(contacts));
renderContactButtons();
closeSettings();
}

function loadNameHistory() {
let history = JSON.parse(localStorage.getItem('nameHistory') || '[]');
const datalist = document.getElementById('nameHistory');
datalist.innerHTML = '';
history.forEach(n => {
const option = document.createElement('option');
option.value = n;
datalist.appendChild(option);
});
}

function saveNameHistory(name) {
if(!name) return;
let history = JSON.parse(localStorage.getItem('nameHistory') || '[]');
if(!history.includes(name)) {
history.push(name);
localStorage.setItem('nameHistory', JSON.stringify(history));
loadNameHistory();
}
}

async function loadAllBlessings() {
const loadingStatus = document.getElementById('loadingStatus');
try {
const promises = jsonFiles.map(url => fetch(url).then(res => {
if(!res.ok) throw new Error(`× ×›×©×œ ×‘×˜×¢×™× ×ª: ${url}`);
return res.json();
}));

const results = await Promise.all(promises);
results.forEach(data => { generators = { ...generators, ...data }; });

document.getElementById('loadingOverlay').style.display = 'none';
document.getElementById('genBtn').disabled = false;
document.getElementById('genBtn').style.display = 'none';

} catch (error) {
console.error(error);
loadingStatus.innerText = "âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×";
setTimeout(() => document.getElementById('loadingOverlay').style.display = 'none', 2000);
}
}

function updateSenderUI() {
document.getElementById('senderMale').classList.remove('active');
document.getElementById('senderFemale').classList.remove('active');
if (state.senderGender === 'male') {
document.getElementById('senderMale').classList.add('active');
document.documentElement.style.setProperty('--primary', '#4f46e5');
} else {
document.getElementById('senderFemale').classList.add('active');
document.documentElement.style.setProperty('--primary', '#db2777');
}
}

function setSenderGender(g) {
state.senderGender = g;
localStorage.setItem('senderGender', g);
updateSenderUI();
}

const emojis = {
shabbat: ["ğŸ•¯ï¸", "ğŸ·", "âœ¨", "ğŸ¥–", "ğŸ•", "ğŸ‡", "ğŸ¤", "ğŸ•Šï¸", "ğŸ¡", "ğŸ’"],
motzash: ["ğŸ¸", "ğŸ•¯ï¸", "ğŸ·", "âœ¨", "ğŸŒš", "ğŸ¶", "ğŸ’«", "ğŸ¯", "ğŸ§¿", "ğŸŒŸ"],
morning: ["â˜€ï¸", "â˜•", "ğŸŒ¼", "ğŸ¥", "ğŸ§¡", "âœ¨", "×™×•× × ×¤×œ×"],
noon: ["ğŸŒ¤ï¸", "ğŸ¥—", "ğŸ¥¤", "ğŸ˜", "ğŸ’ª", "×”××©×š ×™×•× × ×¢×™×"],
night: ["ğŸŒ™", "â­", "ğŸ’¤", "ğŸ›ï¸", "âœ¨", "×—×œ×•××•×ª ×¤×–"],
wedding: ["ğŸ’", "ğŸ’’", "ğŸ¥‚", "ğŸ¤µ", "ğŸ‘°"],
bar_mitzvah: ["ğŸ“–", "ğŸ¬", "ğŸ•", "âœ¡ï¸", "ğŸ’™"],
bat_mitzvah: ["ğŸ“–", "ğŸŒ¸", "ğŸ•", "âœ¡ï¸", "ğŸ’–"],
brit_milah: ["ğŸ‘¶", "ğŸ¼", "ğŸ’™", "âœ¡ï¸"],
brita: ["ğŸ‘¶", "ğŸ¼", "ğŸ’–", "ğŸŒ¸"],
birth_boy: ["ğŸ‘¶", "ğŸ’™", "ğŸ¼", "ğŸš™", "ğŸ§¸"],
birth_girl: ["ğŸ‘¶", "ğŸ’–", "ğŸ€", "ğŸŒ¸", "ğŸ¦„"],
housewarming: ["ğŸ ", "ğŸ”‘", "ğŸª´", "ğŸ§¿"],
henna: ["ğŸ¤š", "ğŸ¬", "ğŸ•Œ", "ğŸ‘˜"],
birthday: ["ğŸ‚", "ğŸ¥³", "ğŸ", "ğŸˆ", "ğŸ°"],
general: ["âœ¨", "ğŸŒ¸", "ğŸ’«", "ğŸŒŸ", "ğŸ™Œ", "ğŸ’", "ğŸ’", "ğŸ¦‹", "ğŸŒˆ", "â˜€ï¸"],
recovery: ["ğŸ’Š", "ğŸ©º", "ğŸ’ª", "â¤ï¸"],
love: ["â¤ï¸", "ğŸ˜", "ğŸ’‹", "ğŸ’˜", "ğŸŒ¹"],
success: ["ğŸ†", "ğŸ’¼", "ğŸš€", "ğŸ“ˆ", "â­", "ğŸ’°"],
thank_you: ["ğŸ™", "ğŸ’", "ğŸ’–", "ğŸŒº"],
rosh_hashanah: ["ğŸ", "ğŸ¯", "ğŸ"],
hanukkah: ["ğŸ•", "ğŸ©", "ğŸ•¯ï¸"],
passover: ["ğŸ·", "ğŸ¥¬"],
purim: ["ğŸ­", "ğŸ·"],
tu_bishvat: ["ğŸŒ³", "ğŸŒ±", "ğŸ‡", "ğŸŠ", "ğŸŒ§ï¸"],
simchat_torah: ["ğŸ“œ", "ğŸ’ƒ", "ğŸ•", "ğŸ™Œ"],
yom_haatzmaut: ["ğŸ‡®ğŸ‡±", "ğŸ†", "ğŸ’™", "ğŸ–"],
lag_baomer: ["ğŸ”¥", "ğŸ¥”", "ğŸ•¯ï¸", "ğŸ¹"],
tu_beav: ["â¤ï¸", "ğŸ’‘", "ğŸ’", "ğŸ’Œ"],
rosh_chodesh: ["ğŸŒ‘", "ğŸ“…", "âœ¨", "ğŸ™"],
mimouna: ["ğŸ¥", "ğŸ¯", "ğŸª", "ğŸª•"],
chabad: ["ğŸ‘‘", "ğŸ•¯ï¸", "ğŸ•", "ğŸ“œ", "ğŸ“–"]
};

function updateEmojiUI() {
const btn = document.getElementById('emojiBtn');
const icon = document.getElementById('emojiIcon');
if (state.useEmojis) {
btn.classList.add('active');
icon.innerText = "âœ…";
} else {
btn.classList.remove('active');
icon.innerText = "âšª";
}
}

function toggleEmoji() {
state.useEmojis = !state.useEmojis;
localStorage.setItem('useEmojis', state.useEmojis);
updateEmojiUI();
}

function goBack() {
let currentEmojiState = state.useEmojis;
let currentSender = state.senderGender;
let currentLength = state.length;
state = {
category: null,
subCategory: null,
shabbatTime: null,
holidayName: null,
holidayTarget: null,
chabadDate: null,
chabadTarget: null,
timeOfDay: null,
length: currentLength,
gender: null,
recipientGender: null,
relationKey: null,
birthType: null,
useEmojis: currentEmojiState,
senderGender: currentSender
};
document.getElementById('nameInput').value = "";
document.getElementById('ageInput').value = "";
document.getElementById('output').innerHTML = '<div style="opacity:0.5; text-align:center; padding-top:10px;"><i class="fa-regular fa-comment-dots" style="font-size:2rem; margin-bottom:10px; display:block; color:#cbd5e1;"></i>×”×‘×¨×›×” ×ª×•×¤×™×¢ ×›××Ÿ...</div>';
document.getElementById('mainGrid').style.display = 'grid';
document.getElementById('genBtn').style.display = 'none';
// ×”×¡×ª×¨×ª ×©×•×¨×ª ×”××¤×©×¨×•×™×•×ª ×‘×¢×ª ×—×–×¨×” ×œ×ª×¤×¨×™×˜
document.getElementById('optionsRow').style.display = 'none';
document.querySelectorAll('.dynamic-section').forEach(el => el.style.display = 'none');
document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
document.getElementById('holidayTargetSelector').style.display = 'none';
document.getElementById('timeTargetSelector').style.display = 'none';
updateSenderUI();
}

function selectCategory(cat, btn) {
state.category = cat;
document.getElementById('mainGrid').style.display = 'none';
document.getElementById('inputSection').style.display = 'block';
// ×”×¦×’×ª ×©×•×¨×ª ×”××¤×©×¨×•×™×•×ª ×‘×¨×’×¢ ×©× ×›× ×¡×™× ×œ×§×˜×’×•×¨×™×”
document.getElementById('optionsRow').style.display = 'flex';
document.querySelectorAll('.dynamic-section').forEach(el => el.style.display = 'none');

if (cat === 'morning_evening') {
document.getElementById('morningEveningSection').style.display = 'block';
document.getElementById('timeTargetSelector').style.display = 'none';
}
else if (cat === 'shabbat') {
document.getElementById('shabbatSection').style.display = 'block';
document.getElementById('shabbatTimeSelector').style.display = 'block';
document.getElementById('shabbatTargetSelector').style.display = 'none';
}
else if (cat === 'holiday') {
document.getElementById('holidaySection').style.display = 'block';
document.getElementById('holidayNameSelector').style.display = 'block';
document.getElementById('holidayTargetSelector').style.display = 'none';
}
else if (cat === 'chabad') {
document.getElementById('chabadSection').style.display = 'block';
}
else if (cat === 'event') document.getElementById('eventSection').style.display = 'block';
else if (cat === 'birth') {
document.getElementById('birthSection').style.display = 'block';
document.getElementById('birthSubTargetSection').style.display = 'none';
}
else if (cat === 'birthday') document.getElementById('birthdaySection').style.display = 'block';
else if (cat === 'recovery') {
document.getElementById('recoveryTargetSection').style.display = 'block';
}
else if (cat === 'thank_you') {
document.getElementById('thankYouTargetSection').style.display = 'block';
}
else if (['success', 'love'].includes(cat)) {
document.getElementById('genderSection').style.display = 'block';
} else {
document.getElementById('genBtn').style.display = 'flex';
}
}

function selectTimeOfDay(time, btn) {
state.timeOfDay = time;
const btns = document.querySelectorAll('#timeOfDaySelector .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('timeTargetSelector').style.display = 'block';
document.getElementById('genBtn').style.display = 'none';
}

function selectTimeTarget(target, btn) {
state.subCategory = target;
if (target === 'husband') state.recipientGender = 'male';
if (target === 'wife') state.recipientGender = 'female';
const btns = document.querySelectorAll('#timeTargetSelector .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('genBtn').style.display = 'flex';
}

function selectShabbatTime(time) {
state.shabbatTime = time;
const btns = document.querySelectorAll('#shabbatTimeSelector .sub-btn');
btns.forEach(b => b.classList.remove('active'));
event.target.classList.add('active');
document.getElementById('shabbatTargetSelector').style.display = 'block';
document.getElementById('genBtn').style.display = 'flex';
}

function selectSub(type, btn) {
if (type.startsWith('chabad_')) {
state.chabadDate = type;
let parent = btn.parentElement;
parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
if (state.chabadTarget) document.getElementById('genBtn').style.display = 'flex';
return;
}
if (state.category === 'chabad' && !type.startsWith('chabad_')) {
state.chabadTarget = type;
let parent = btn.parentElement;
parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
if (state.chabadDate) document.getElementById('genBtn').style.display = 'flex';
return;
}

state.subCategory = type;
const maleTargets = ['husband', 'brother', 'friend_male', 'dad', 'grandson', 'boy'];
const femaleTargets = ['wife', 'sister', 'friend_female', 'mom', 'granddaughter', 'girl'];
if (maleTargets.includes(type)) state.recipientGender = 'male';
if (femaleTargets.includes(type)) state.recipientGender = 'female';

let parent = btn.parentElement;
parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('genBtn').style.display = 'flex';
}

function selectHolidayName(hName, btn) {
state.holidayName = hName;
const btns = document.querySelectorAll('#holidayNameSelector .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('holidayTargetSelector').style.display = 'block';
document.getElementById('genBtn').style.display = 'flex';
}

function selectHolidayTarget(target, btn) {
state.holidayTarget = target;
if (['husband', 'brother', 'friend_male', 'father'].includes(target)) state.recipientGender = 'male';
if (['wife', 'sister', 'friend_female', 'mother'].includes(target)) state.recipientGender = 'female';
const btns = document.querySelectorAll('#holidayTargetSelector .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
}

function selectBirthType(type) {
state.birthType = type;
const btns = document.querySelectorAll('#birthSection > .sub-grid > .sub-btn');
btns.forEach(b => b.classList.remove('active'));
event.target.classList.add('active');

const targetContainer = document.getElementById('birthTargetButtons');
targetContainer.innerHTML = '';
document.getElementById('birthSubTargetSection').style.display = 'block';
document.getElementById('birthTargetTitle').innerText = (type === 'birth_boy') ? "×œ××™ × ×•×œ×“ ×”×‘×Ÿ?" : "×œ××™ × ×•×œ×“×” ×”×‘×ª?";

const targets = (type === 'birth_boy') ?
[
{key: 'brother', label: '×œ××—', icon: 'fa-solid fa-user'},
{key: 'friend', label: '×œ×—×‘×¨', icon: 'fa-solid fa-user-group'},
{key: 'neighbor', label: '×œ×©×›×Ÿ', icon: 'fa-solid fa-house-user'},
{key: 'family', label: '×œ×‘×Ÿ ××©×¤×—×”', icon: 'fa-solid fa-people-roof'}
] :
[
{key: 'sister', label: '×œ××—×•×ª', icon: 'fa-solid fa-person-dress'},
{key: 'friend', label: '×œ×—×‘×¨×”', icon: 'fa-solid fa-user-group'},
{key: 'neighbor', label: '×œ×©×›× ×”', icon: 'fa-solid fa-house-user'},
{key: 'family', label: '×œ×‘×ª ××©×¤×—×”', icon: 'fa-solid fa-people-roof'}
];

targets.forEach(t => {
const b = document.createElement('button');
b.className = 'sub-btn';
b.innerHTML = `<i class="${t.icon}"></i> ${t.label}`;
b.onclick = (e) => selectBirthSubTarget(t.key, e.target.closest('button'));
targetContainer.appendChild(b);
});
}

function selectBirthSubTarget(target, btn) {
state.subCategory = target;
const btns = document.querySelectorAll('#birthTargetButtons .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('genBtn').style.display = 'flex';
}

function selectRecoveryTarget(target, btn) {
state.subCategory = target;
if(['male', 'dad', 'brother', 'son', 'friend_male'].includes(target)) state.recipientGender = 'male';
if(['female', 'mom', 'sister', 'daughter', 'friend_female'].includes(target)) state.recipientGender = 'female';

const btns = document.querySelectorAll('#recoveryTargetSection .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('genBtn').style.display = 'flex';
}

function selectThankYouTarget(target, btn) {
state.subCategory = target;
if(['male_general', 'father', 'brother', 'friend_male'].includes(target)) state.recipientGender = 'male';
if(['female_general', 'mother', 'sister', 'friend_female'].includes(target)) state.recipientGender = 'female';

const btns = document.querySelectorAll('#thankYouTargetSection .sub-btn');
btns.forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('genBtn').style.display = 'flex';
}

function selectGenderGeneral(g, btn) {
state.gender = g;
state.recipientGender = g;
let parent = btn.parentElement;
parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
document.getElementById('genBtn').style.display = 'flex';
}

function selectGender(gender, btn) {
state.gender = gender;
if (gender === 'man' || gender === 'boy') state.recipientGender = 'male';
if (gender === 'woman' || gender === 'girl') state.recipientGender = 'female';

let parent = btn.parentElement;
parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');

const relationsMap = {
man: [
{ label: "×—×‘×¨", key: "friend_male", icon: "fa-solid fa-user-group" },
{ label: "××—", key: "brother", icon: "fa-solid fa-user" },
{ label: "××‘×", key: "dad", icon: "fa-solid fa-user-tie" },
{ label: "×‘×¢×œ×™", key: "husband", icon: "fa-solid fa-ring" },
{ label: "×‘×Ÿ ×–×•×’×™", key: "partner_male", icon: "fa-solid fa-heart" }
],
woman: [
{ label: "×—×‘×¨×”", key: "friend_female", icon: "fa-solid fa-user-group" },
{ label: "××—×•×ª", key: "sister", icon: "fa-solid fa-person-dress" },
{ label: "×××", key: "mom", icon: "fa-solid fa-person-breastfeeding" },
{ label: "××©×ª×™", key: "wife", icon: "fa-solid fa-ring" },
{ label: "×‘×ª ×–×•×’×ª×™", key: "partner_female", icon: "fa-solid fa-heart" }
],
boy: [
{ label: "×™×œ×“", key: "boy", icon: "fa-solid fa-child" },
{ label: "×‘×Ÿ", key: "son", icon: "fa-solid fa-child" },
{ label: "× ×›×“", key: "boy", icon: "fa-solid fa-child-reaching" },
{ label: "×—×‘×¨", key: "boy", icon: "fa-solid fa-user-group" }
],
girl: [
{ label: "×™×œ×“×”", key: "girl", icon: "fa-solid fa-child-dress" },
{ label: "×‘×ª", key: "daughter", icon: "fa-solid fa-child-dress" },
{ label: "× ×›×“×”", key: "girl", icon: "fa-solid fa-child-reaching" },
{ label: "×—×‘×¨×”", key: "girl", icon: "fa-solid fa-user-group" }
]
};
const grid = document.getElementById('relationsGrid');
grid.innerHTML = '';
(relationsMap[gender] || []).forEach(relItem => {
const b = document.createElement('button');
b.className = 'sub-btn';
b.innerHTML = `<i class="${relItem.icon}"></i> ${relItem.label}`;
b.onclick = (e) => {
state.relationKey = relItem.key;
if (['husband','partner_male','brother','friend_male','son','dad'].includes(relItem.key)) state.recipientGender = 'male';
if (['wife','partner_female','sister','friend_female','daughter','mom'].includes(relItem.key)) state.recipientGender = 'female';
grid.querySelectorAll('.sub-btn').forEach(x => x.classList.remove('active'));
e.target.closest('button').classList.add('active');
};
grid.appendChild(b);
});
document.getElementById('relationsContainer').style.display = 'block';
document.getElementById('genBtn').style.display = 'flex';
}

function getDistinctRandom(arr, count) {
if (!arr || arr.length === 0) return [];
const shuffled = [...arr].sort(() => 0.5 - Math.random());
return shuffled.slice(0, count);
}

function smartGrammarFix(text) {
let clean = text;
if (state.senderGender === 'female') {
const senderReplacements = [
{ m: "×××—×œ", f: "×××—×œ×ª" }, { m: "××•×”×‘", f: "××•×”×‘×ª" }, { m: "××¢×¨×™×š", f: "××¢×¨×™×›×”" },
{ m: "×©×•×œ×—", f: "×©×•×œ×—×ª" }, { m: "×‘×˜×•×—", f: "×‘×˜×•×—×”" }, { m: "×—×•×©×‘", f: "×—×•×©×‘×ª" },
{ m: "××ª×’×¢×’×¢", f: "××ª×’×¢×’×¢×ª" }, { m: "××•×§×™×¨", f: "××•×§×™×¨×”" }, { m: "××××™×Ÿ", f: "××××™× ×”" },
{ m: "×¡×•××š", f: "×¡×•××›×ª" }, { m: "××—×–×™×§", f: "××—×–×™×§×”" }, { m: "××•×“×”", f: "××•×“×”" },
{ m: "×›×•×ª×‘", f: "×›×•×ª×‘×ª" }, { m: "××‘×§×©", f: "××‘×§×©×ª" }
];
senderReplacements.forEach(pair => {
clean = clean.replace(new RegExp(pair.m, 'g'), pair.f);
});
}
if (state.recipientGender) {
if (state.recipientGender === 'male') {
const toMaleMap = [
{ wrong: "×™×§×¨×”", right: "×™×§×¨" }, { wrong: "××”×•×‘×”", right: "××”×•×‘" },
{ wrong: "××“×”×™××”", right: "××“×”×™×" }, { wrong: "××§×¡×™××”", right: "××§×¡×™×" },
{ wrong: "××•×©×œ××ª", right: "××•×©×œ×" }, { wrong: "×”×˜×•×‘×”", right: "×”×˜×•×‘" },
{ wrong: "××ª", right: "××ª×”" }, { wrong: "×©×œ×š", right: "×©×œ×š" },
{ wrong: "×‘×©×‘×™×œ×š", right: "×‘×©×‘×™×œ×š" }, { wrong: "××œ×™×™×š", right: "××œ×™×™×š" },
{ wrong: "× ×”×“×¨×ª", right: "× ×”×“×¨" }, { wrong: "×—×©×•×‘×”", right: "×—×©×•×‘" },
{ wrong: "×‘×¨×™××”", right: "×‘×¨×™×" }, { wrong: "×—×–×§×”", right: "×—×–×§" }
];
toMaleMap.forEach(pair => {
clean = clean.replace(new RegExp(`\\b${pair.wrong}\\b`, 'g'), pair.right);
});
}
else if (state.recipientGender === 'female') {
const toFemaleMap = [
{ wrong: "×™×§×¨", right: "×™×§×¨×”" }, { wrong: "××”×•×‘", right: "××”×•×‘×”" },
{ wrong: "××“×”×™×", right: "××“×”×™××”" }, { wrong: "××§×¡×™×", right: "××§×¡×™××”" },
{ wrong: "××•×©×œ×", right: "××•×©×œ××ª" }, { wrong: "×”×˜×•×‘", right: "×”×˜×•×‘×”" },
{ wrong: "××ª×”", right: "××ª" }, { wrong: "× ×”×“×¨", right: "× ×”×“×¨×ª" },
{ wrong: "×—×©×•×‘", right: "×—×©×•×‘×”" }, { wrong: "××œ×š", right: "××œ×›×”" },
{ wrong: "××œ×•×£", right: "××œ×•×¤×”" }, { wrong: "×‘×¨×™×", right: "×‘×¨×™××”" },
{ wrong: "×—×–×§", right: "×—×–×§×”" }
];
toFemaleMap.forEach(pair => {
clean = clean.replace(new RegExp(`\\b${pair.wrong}\\b`, 'g'), pair.right);
});
}
}
return clean;
}

function generateBlessing() {
document.getElementsByName('length').forEach(l => { if(l.checked) state.length = l.value });
const output = document.getElementById('output');
let key = "";
let fallbackKey = null;

if (state.category === 'morning_evening') {
if (!state.timeOfDay || !state.subCategory) { alert("× × ×œ×‘×—×•×¨ ×–××Ÿ ×•×™×¢×“..."); return; }
key = `${state.timeOfDay}_${state.subCategory}`;
}
else if (state.category === 'shabbat') {
if (!state.shabbatTime || !state.subCategory) { alert("× × ×œ×‘×—×•×¨ ×–××Ÿ ×•×™×¢×“..."); return; }
key = `${state.shabbatTime}_${state.subCategory}`;
fallbackKey = `shabbat_${state.subCategory}`;
}
else if (state.category === 'holiday') {
if (!state.holidayName || !state.holidayTarget) { alert("× × ×œ×‘×—×•×¨ ×—×’ ×•×™×¢×“..."); return; }
key = `${state.holidayName}_${state.holidayTarget}`;
fallbackKey = `holiday_${state.holidayTarget}`;
}
else if (state.category === 'chabad') {
if (!state.chabadDate || !state.chabadTarget) { alert("× × ×œ×‘×—×•×¨ ×ª××¨×™×š ×•×™×¢×“..."); return; }
key = `${state.chabadDate}_${state.chabadTarget}`;
}
else if (state.category === 'event') {
if (!state.subCategory) { alert("× × ×œ×‘×—×•×¨..."); return; }
key = state.subCategory;
}
else if (state.category === 'birth') {
if (!state.subCategory) { alert("× × ×œ×‘×—×•×¨ ×œ××™ × ×•×œ×“..."); return; }
key = `${state.birthType}_${state.subCategory}`;
fallbackKey = state.birthType;
}
else if (state.category === 'recovery') {
if (!state.subCategory) { alert("× × ×œ×‘×—×•×¨ ×œ××™..."); return; }
key = `recovery_${state.subCategory}`;
}
else if (state.category === 'thank_you') {
if (!state.subCategory) { alert("× × ×œ×‘×—×•×¨ ×œ××™..."); return; }
key = `thank_you_${state.subCategory}`;
}
else if (state.category === 'birthday') {
if (state.relationKey) {
key = `birthday_${state.relationKey}`;
} else {
const bdKey = (state.gender === 'woman' || state.gender === 'girl' || state.gender === 'female') ? 'birthday_female' : 'birthday_male';
key = bdKey;
}
}
else if (['success', 'love'].includes(state.category)) {
if (!state.gender) { alert("× × ×œ×‘×—×•×¨ ××™×Ÿ..."); return; }
key = `${state.category}_${state.gender}`;
}
else {
key = state.category;
}

let gen = generators[key];
if (!gen && localBlessings[key]) {
gen = localBlessings[key];
}

if (!gen && fallbackKey && generators[fallbackKey]) {
gen = generators[fallbackKey];
}

if (!gen) {
if (state.category === 'shabbat') gen = generators[`${state.shabbatTime}_general`];
else if (state.category === 'holiday') gen = generators[`${state.holidayName}_general`] || generators[`${state.holidayName}`];
else if (state.category === 'chabad') gen = generators[state.chabadDate];
else if (state.category === 'birthday') {
const fallbackKey = (state.gender === 'woman' || state.gender === 'girl') ? 'birthday_female' : 'birthday_male';
gen = generators[fallbackKey];
}
}

if (!gen) {
output.innerHTML = `<div style="color:red; text-align:center">×œ× × ××¦××• ×‘×¨×›×•×ª ×œ×§×˜×’×•×¨×™×”: ${key}</div>`;
return;
}

let parts = [];
const name = document.getElementById('nameInput').value.trim();
saveNameHistory(name);

if (name) {
let suffix = "×”×™×§×¨/×”";
const isWifeContext = (state.relationKey === 'wife' || state.relationKey === 'partner_female' || state.holidayTarget === 'wife' || state.subCategory === 'wife');
const isHusbandContext = (state.relationKey === 'husband' || state.relationKey === 'partner_male' || state.holidayTarget === 'husband' || state.subCategory === 'husband');

const isGenericFemale = (state.gender === 'woman' || state.gender === 'girl' || state.gender === 'female' || state.recipientGender === 'female');
const isGenericMale = (state.gender === 'man' || state.gender === 'boy' || state.gender === 'male' || state.recipientGender === 'male');

if (isWifeContext) {
suffix = wifeSuffixes[Math.floor(Math.random() * wifeSuffixes.length)];
} else if (isHusbandContext) {
suffix = husbandSuffixes[Math.floor(Math.random() * husbandSuffixes.length)];
} else {
if (isGenericFemale) suffix = "×”×™×§×¨×”";
else if (isGenericMale) suffix = "×”×™×§×¨";
}
parts.push(`${name} ${suffix},`);
}

parts.push(getDistinctRandom(gen.openers, 1)[0]);
const bodyCount = state.length === 'long' ? 2 : 1;
const bodies = getDistinctRandom(gen.bodies, bodyCount);
parts.push(...bodies);

if (state.category !== 'morning_evening') {
parts.push(getDistinctRandom(gen.closings, 1)[0]);
}

let adjustedParts = parts.map(part => smartGrammarFix(part));

let emojiSet = 'general';
if (state.category === 'morning_evening') emojiSet = state.timeOfDay;
else if (state.category === 'shabbat') emojiSet = state.shabbatTime;
else if (state.category === 'holiday') emojiSet = state.holidayName;
else if (state.category === 'birth') emojiSet = state.birthType;
else if (state.category === 'chabad') emojiSet = state.chabadDate;
else if (emojis[key]) emojiSet = key;
else if (emojis[state.category]) emojiSet = state.category;

if (state.category === 'chabad' && !emojis[emojiSet]) emojiSet = 'chabad';

renderLinesWithEmojis(adjustedParts, emojiSet);
}

function renderLinesWithEmojis(linesArray, setKey) {
const cleanLines = linesArray.filter(l => l && l.trim() !== "");
let availableEmojis = [...(emojis[setKey] || emojis['general'])];
const container = document.getElementById('output');
container.innerHTML = '';

cleanLines.forEach(line => {
let lineContent = line.trim();
if (state.useEmojis) {
if (availableEmojis.length === 0) availableEmojis = [...(emojis[setKey] || emojis['general'])];
const randomIndex = Math.floor(Math.random() * availableEmojis.length);
const emoji = availableEmojis[randomIndex];
availableEmojis.splice(randomIndex, 1);
lineContent = `${lineContent} ${emoji}`;
}
lineContent = `*${lineContent}*`;
const row = document.createElement('div');
row.className = 'line-item';
row.innerHTML = `
<button class="delete-line-btn" onclick="this.parentElement.remove()" title="××—×§ ×©×•×¨×” ×–×•">âœ•</button>
<div class="line-text" contenteditable="true">${lineContent}</div>
`;
container.appendChild(row);
});
}

function getVisibleText() {
const rows = document.querySelectorAll('.line-text');
return Array.from(rows).map(r => r.innerText.trim()).join('\n');
}

function copyText() {
const textToCopy = getVisibleText();
if(!textToCopy) return;
navigator.clipboard.writeText(textToCopy);
const btn = document.querySelector('.btn-copy');
let old = btn.innerHTML; btn.innerHTML = '<i class="fa-solid fa-check"></i> ×”×•×¢×ª×§!'; setTimeout(() => btn.innerHTML = old, 1500);
}

function sendWhatsapp() {
let text = getVisibleText();
if(!text) return alert("×§×•×“× ×¦×•×¨ ×‘×¨×›×”!");
window.open(`whatsapp://send?text=${encodeURIComponent(text)}`, '_blank');
}
</script>

</body>
</html>
