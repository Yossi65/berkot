<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××¢×¨×›×ª ×”×‘×¨×›×•×ª ×”×—×›××”</title>
    <style>
        /* ×”×’×“×¨×ª ××©×ª× ×™× - ×‘×¨×™×¨×ª ××—×“×œ */
        :root { 
            --primary: #4a90e2; 
            --primary-dark: #357abd; 
            --whatsapp: #25D366; 
            --bg: #e3f2fd;        
            --card: #f0f8ff;      
            --controls-bg: #e1f5fe; 
            --text: #1c1e21; 
            --border-radius: 16px; 
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 10px; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
            padding-bottom: 80px; 
            transition: background-color 0.4s ease; 
        }

        .container { 
            width: 100%; 
            max-width: 600px; 
            background: var(--card); 
            padding: 20px; 
            border-radius: var(--border-radius); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            position: relative; 
            min-height: 600px; 
            transition: background-color 0.4s ease;
        }
        
        h1 { text-align: center; font-size: 1.5rem; margin: 10px 0; color: var(--primary-dark); }
        
        /* ×›×¤×ª×•×¨ ×—×–×¨×” */
        .back-btn { 
            background: #e4e6eb; 
            color: #333; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 12px; 
            font-size: 0.95rem; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%; 
            display: block; 
            margin-bottom: 5px; 
            transition: 0.2s;
        }
        .back-btn:hover { background: #d0d2d6; }

        .controls-area { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            background: var(--controls-bg); 
            padding: 15px; 
            border-radius: 12px; 
            transition: background-color 0.4s ease;
        }

        .top-row { 
            display: flex; 
            justify-content: center; 
            align-items: center;     
            width: 100%; 
            gap: 12px;               
            flex-wrap: wrap;         
        }
        
        .sender-toggle { display: flex; background: rgba(255,255,255,0.5); border-radius: 20px; padding: 3px; height: fit-content; }
        .sender-btn { border: none; background: transparent; padding: 6px 12px; border-radius: 16px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .sender-btn.active { background: white; shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: bold; color: var(--primary-dark); }

        .emoji-btn { background: white; border: 2px solid #ddd; border-radius: 20px; padding: 6px 12px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; transition: all 0.2s; color: #555; font-size: 0.9rem; height: fit-content; }
        .emoji-btn.active { background: #ffeb3b; border-color: #fbc02d; color: #333; }
        
        .length-wrapper { display: flex; flex-direction: column; align-items: center; }
        .length-label-title { font-size: 0.8rem; font-weight: bold; color: #666; margin-bottom: 3px; }
        .length-selector { display: flex; background: rgba(255,255,255,0.5); border-radius: 20px; padding: 3px; }
        .length-selector label { flex: 1; text-align: center; padding: 6px 12px; border-radius: 16px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .length-selector input { display: none; }
        .length-selector input:checked + span { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: var(--primary); font-weight: bold; display: block; border-radius: 16px; padding: 4px 8px; }
        .length-selector span { display: block; }
        
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; transition: all 0.3s ease; }
        @media (min-width: 600px) { .grid-container { grid-template-columns: repeat(5, 1fr); } }
        
        .category-btn { background: white; border: 1px solid #e0e0e0; padding: 15px 5px; border-radius: 12px; font-size: 1rem; cursor: pointer; font-weight: 500; color: #444; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: all 0.2s; }
        .category-btn:hover { transform: translateY(-2px); border-color: var(--primary); }
        .category-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); }

        .dynamic-section { background: #f8f9fa; padding: 15px; border-radius: 12px; display: none; border: 1px solid #eee; animation: fadeIn 0.3s ease; }
        .sub-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .holidays-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        
        .sub-btn { background: white; border: 1px solid #ccc; padding: 12px; border-radius: 10px; font-size: 0.95rem; cursor: pointer; transition: 0.2s; }
        .sub-btn.active { background: var(--primary-dark); color: white; border-color: var(--primary-dark); font-weight: bold; }

        .input-row { display: flex; gap: 10px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        
        .generate-btn { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-top: 10px; }
        .generate-btn:active { transform: scale(0.98); }
        .generate-btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
        
        /* --- ×¢×™×¦×•×‘ ××–×•×¨ ×”×¤×œ×˜ (×©×•×¨×•×ª × ×¤×¨×“×•×ª) --- */
        .output-container { 
            background: #fff9c4; 
            padding: 15px; 
            border-radius: 12px; 
            min-height: 80px; 
            border: 1px dashed #fbc02d; 
            font-size: 1.1rem; 
            line-height: 1.5; 
            margin-top: 15px; 
        }

        .line-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
            animation: fadeIn 0.3s ease;
        }

        .line-text {
            flex: 1;
            padding: 4px 8px;
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.2s;
            cursor: text;
        }
        
        .line-text:focus {
            background: white;
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .delete-line-btn {
            background: #ef5350;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            opacity: 0.7;
        }
        
        .delete-line-btn:hover { opacity: 1; transform: scale(1.1); }

        /* ------------------------------------------- */
        
        .actions-bar { display: flex; gap: 10px; margin-top: 10px; }
        .action-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-copy { background: #e4e6eb; color: #1c1e21; }
        .btn-whatsapp { background: var(--whatsapp); color: white; }
        
        #loadingOverlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; border-radius: 16px; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 1.1rem; color: #555; font-weight: bold; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <span class="loading-text">×˜×•×¢×Ÿ ××œ×¤×™ ×‘×¨×›×•×ª ××”×¢× ×Ÿ...</span>
        <span id="loadingStatus" style="font-size:0.9rem; color:#888; margin-top:5px;">××ª×—×‘×¨ ×œ×©×¨×ª...</span>
    </div>

    <h1>××¤×¢×œ ×”×‘×¨×›×•×ª ğŸš€</h1>

    <div class="controls-area">
        <div class="top-row">
            <div class="sender-toggle">
                <button class="sender-btn active" id="senderMale" onclick="setSenderGender('male')">×’×‘×¨ ğŸ‘¨</button>
                <button class="sender-btn" id="senderFemale" onclick="setSenderGender('female')">××™×©×” ğŸ‘©</button>
            </div>

            <div class="length-wrapper">
                <span class="length-label-title">×‘×¨×›×”</span>
                <div class="length-selector">
                    <label><input type="radio" name="length" value="short" onchange="setLength('short')"><span>×§×¦×¨×”</span></label>
                    <label><input type="radio" name="length" value="long" onchange="setLength('long')" checked><span>××¨×•×›×”</span></label>
                </div>
            </div>

            <button class="emoji-btn active" id="emojiBtn" onclick="toggleEmoji()">
                <span id="emojiIcon">âœ…</span> ××™××•×’'×™
            </button>
        </div>
    </div>

    <button class="back-btn" id="backBtn" onclick="goBack()">ğŸ”™ ×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™</button>

    <div class="grid-container" id="mainGrid">
        <button class="category-btn" style="background:#e0f7fa; border-color:#00bcd4;" onclick="selectCategory('morning_evening', this)">×‘×•×§×¨/×¢×¨×‘ â˜€ï¸ğŸŒ™</button>
        <button class="category-btn" onclick="selectCategory('shabbat', this)">×©×‘×ª / ××•×¦"×© ğŸ•¯ï¸</button>
        <button class="category-btn" onclick="selectCategory('holiday', this)">×—×’ ğŸ·</button>
        <button class="category-btn" style="background:#fff9c4; border-color:#fbc02d;" onclick="selectCategory('chabad', this)">×—×‘"×“ ğŸ‘‘</button>
        <button class="category-btn" onclick="selectCategory('birthday', this)">×™×•× ×”×•×œ×“×ª ğŸ‚</button>
        <button class="category-btn" onclick="selectCategory('event', this)">××™×¨×•×¢ ğŸ’</button>
        <button class="category-btn" onclick="selectCategory('birth', this)">×œ×™×“×” ğŸ‘¶</button>
        <button class="category-btn" onclick="selectCategory('recovery', this)">×¨×¤×•××” ğŸ’Š</button>
        <button class="category-btn" onclick="selectCategory('thank_you', this)">×ª×•×“×” ğŸ™</button>
        <button class="category-btn" onclick="selectCategory('success', this)">×”×¦×œ×—×” ğŸ†</button>
        <button class="category-btn" onclick="selectCategory('love', this)">××”×‘×” â¤ï¸</button>
    </div>

    <div id="morningEveningSection" class="dynamic-section">
        <div id="timeOfDaySelector">
            <h3>××” ×”×©×¢×”?</h3>
            <div class="sub-grid" style="grid-template-columns: repeat(3, 1fr);">
                <button class="sub-btn" onclick="selectTimeOfDay('morning', this)">×‘×•×§×¨ ×˜×•×‘ â˜€ï¸</button>
                <button class="sub-btn" onclick="selectTimeOfDay('noon', this)">×¦×”×¨×™×™× ×˜×•×‘×™× ğŸŒ¤ï¸</button>
                <button class="sub-btn" onclick="selectTimeOfDay('night', this)">×œ×™×œ×” ×˜×•×‘ ğŸŒ™</button>
            </div>
        </div>
        <div id="timeTargetSelector" style="display:none; margin-top:15px;">
            <h3>×œ××™ ×”×‘×¨×›×”?</h3>
            <div class="sub-grid">
                <button class="sub-btn" onclick="selectTimeTarget('general', this)">×›×œ×œ×™ âœ¨</button>
                <button class="sub-btn" onclick="selectTimeTarget('husband', this)">×œ×‘×¢×œ×™ ğŸ¤µ</button>
                <button class="sub-btn" onclick="selectTimeTarget('wife', this)">×œ××©×ª×™ ğŸ‘°</button>
            </div>
        </div>
    </div>

    <div id="shabbatSection" class="dynamic-section">
        <div id="shabbatTimeSelector">
            <h3>××” ×”×–××Ÿ ×¢×›×©×™×•?</h3>
            <div class="sub-grid">
                <button class="sub-btn" onclick="selectShabbatTime('shabbat')">ğŸ•¯ï¸ ×œ×§×¨××ª ×©×‘×ª</button>
                <button class="sub-btn" onclick="selectShabbatTime('motzash')">ğŸ¸ ××•×¦××™ ×©×‘×ª</button>
            </div>
        </div>
        <div id="shabbatTargetSelector" style="display:none;">
            <h3 id="shabbatTargetTitle">×œ××™ ×”×‘×¨×›×”?</h3>
            <div class="sub-grid">
                <button class="sub-btn" onclick="selectSub('general', this)">×›×œ×œ×™ âœ¨</button>
                <button class="sub-btn" onclick="selectSub('family', this)">×œ××©×¤×—×” ğŸ </button>
                <button class="sub-btn" onclick="selectSub('wife', this)">×œ××©×ª×™ ğŸ‘°</button>
                <button class="sub-btn" onclick="selectSub('husband', this)">×œ×‘×¢×œ×™ ğŸ¤µ</button>
                <button class="sub-btn" onclick="selectSub('parents', this)">×œ×”×•×¨×™× ğŸ‘´ğŸ‘µ</button>
                <button class="sub-btn" onclick="selectSub('kids', this)">×œ×™×œ×“×™× ğŸ§¸</button>
                <button class="sub-btn" onclick="selectSub('brother', this)">×œ××— ğŸ‘¦</button>
                <button class="sub-btn" onclick="selectSub('sister', this)">×œ××—×•×ª ğŸ‘§</button>
                <button class="sub-btn" onclick="selectSub('friend_male', this)">×œ×—×‘×¨ ğŸ¤œğŸ¤›</button>
                <button class="sub-btn" onclick="selectSub('friend_female', this)">×œ×—×‘×¨×” ğŸ‘¯â€â™€ï¸</button>
                </div>
        </div>
    </div>

    <div id="holidaySection" class="dynamic-section">
        <div id="holidayNameSelector">
            <h3>××™×–×” ×—×’ ×—×•×’×’×™×?</h3>
            <div class="holidays-grid">
                <button class="sub-btn" style="background:#e3f2fd; border-color:#2196f3; font-weight:bold;" onclick="selectHolidayName('rosh_chodesh', this)">×¨××© ×—×•×“×© ğŸŒ‘</button>
                <button class="sub-btn" onclick="selectHolidayName('rosh_hashanah', this)">×¨"×”×©× ×” ğŸ</button>
                <button class="sub-btn" onclick="selectHolidayName('yom_kippur', this)">×›×™×¤×•×¨ âš–ï¸</button>
                <button class="sub-btn" onclick="selectHolidayName('sukkot', this)">×¡×•×›×•×ª ğŸŒ¿</button>
                <button class="sub-btn" onclick="selectHolidayName('simchat_torah', this)">×©××—×ª ×ª×•×¨×” ğŸ“œ</button>
                <button class="sub-btn" onclick="selectHolidayName('hanukkah', this)">×—× ×•×›×” ğŸ•</button>
                <button class="sub-btn" onclick="selectHolidayName('tu_bishvat', this)">×˜"×• ×‘×©×‘×˜ ğŸŒ³</button>
                <button class="sub-btn" onclick="selectHolidayName('purim', this)">×¤×•×¨×™× ğŸ­</button>
                <button class="sub-btn" onclick="selectHolidayName('passover', this)">×¤×¡×— ğŸ·</button>
                <button class="sub-btn" onclick="selectHolidayName('mimouna', this)">××™××•× ×” ğŸ¥</button>
                <button class="sub-btn" onclick="selectHolidayName('yom_haatzmaut', this)">×”×¢×¦×××•×ª ğŸ‡®ğŸ‡±</button>
                <button class="sub-btn" onclick="selectHolidayName('lag_baomer', this)">×œ"×’ ×‘×¢×•××¨ ğŸ”¥</button>
                <button class="sub-btn" onclick="selectHolidayName('shavuot', this)">×©×‘×•×¢×•×ª ğŸŒ¾</button>
                <button class="sub-btn" onclick="selectHolidayName('tu_beav', this)">×˜"×• ×‘××‘ â¤ï¸</button>
                <button class="sub-btn" onclick="selectHolidayName('generic_holiday', this)">×›×œ×œ×™ ğŸ‰</button>
            </div>
        </div>
        
        <div id="holidayTargetSelector" style="display:none; margin-top:15px;">
            <h3>×œ××™ ×‘×¨×›×ª ×”×—×’?</h3>
            <div class="sub-grid">
                <button class="sub-btn" onclick="selectHolidayTarget('general', this)">×›×œ×œ×™ âœ¨</button>
                <button class="sub-btn" onclick="selectHolidayTarget('family', this)">×œ××©×¤×—×” ğŸ </button>
                <button class="sub-btn" onclick="selectHolidayTarget('wife', this)">×œ××©×ª×™ ğŸ‘°</button>
                <button class="sub-btn" onclick="selectHolidayTarget('husband', this)">×œ×‘×¢×œ×™ ğŸ¤µ</button>
                <button class="sub-btn" onclick="selectHolidayTarget('parents', this)">×œ×”×•×¨×™× ğŸ‘´ğŸ‘µ</button>
                <button class="sub-btn" onclick="selectHolidayTarget('kids', this)">×œ×™×œ×“×™× ğŸ§¸</button>
                <button class="sub-btn" onclick="selectHolidayTarget('brother', this)">×œ××— ğŸ‘¦</button>
                <button class="sub-btn" onclick="selectHolidayTarget('sister', this)">×œ××—×•×ª ğŸ‘§</button>
                <button class="sub-btn" onclick="selectHolidayTarget('friend_male', this)">×œ×—×‘×¨ ğŸ¤œğŸ¤›</button>
                <button class="sub-btn" onclick="selectHolidayTarget('friend_female', this)">×œ×—×‘×¨×” ğŸ‘¯â€â™€ï¸</button>
                <button class="sub-btn" onclick="selectHolidayTarget('group', this)">×œ×§×‘×•×¦×” ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</button>
            </div>
        </div>
    </div>

    <div id="chabadSection" class="dynamic-section">
        <h3>×ª××¨×™×š ×—×¡×™×“×™</h3>
        <div class="holidays-grid">
            <button class="sub-btn" onclick="selectSub('chabad_19_kislev', this)">×™"×˜ ×›×¡×œ×• ğŸ“–</button>
            <button class="sub-btn" onclick="selectSub('chabad_10_shevat', this)">×™' ×©×‘×˜ ğŸ•¯ï¸</button>
            <button class="sub-btn" onclick="selectSub('chabad_11_nissan', this)">×™"× × ×™×¡×Ÿ ğŸ‘‘</button>
            <button class="sub-btn" onclick="selectSub('chabad_3_tammuz', this)">×’' ×ª××•×– ğŸ•¯ï¸</button>
            <button class="sub-btn" onclick="selectSub('chabad_12_tammuz', this)">×™"×‘-×™"×’ ×ª××•×– ğŸ”“</button>
            <button class="sub-btn" onclick="selectSub('chabad_18_elul', this)">×—"×™ ××œ×•×œ âœ¨</button>
            <button class="sub-btn" onclick="selectSub('chabad_5_tevet', this)">×”' ×˜×‘×ª ğŸ“š</button>
            <button class="sub-btn" onclick="selectSub('chabad_22_shevat', this)">×›"×‘ ×©×‘×˜ ğŸ•¯ï¸</button>
            <button class="sub-btn" onclick="selectSub('chabad_24_tevet', this)">×›"×“ ×˜×‘×ª ğŸ“œ</button>
            <button class="sub-btn" onclick="selectSub('chabad_14_kislev', this)">×™"×“ ×›×¡×œ×• ğŸ’</button>
            <button class="sub-btn" onclick="selectSub('chabad_2_iyar', this)">×‘' ××™×™×¨ ğŸš€</button>
            <button class="sub-btn" onclick="selectSub('chabad_6_tishrei', this)">×•' ×ª×©×¨×™ ğŸ•¯ï¸</button>
        </div>
        
        <h3 style="margin-top:15px;">×œ××™ ×”×‘×¨×›×”?</h3>
        <div class="sub-grid">
            <button class="sub-btn" onclick="selectSub('general', this)">×›×œ×œ×™</button>
            <button class="sub-btn" onclick="selectSub('family', this)">×œ××©×¤×—×”</button>
        </div>
    </div>

    <div id="eventSection" class="dynamic-section">
        <h3>××™×–×” ××™×¨×•×¢ ×—×•×’×’×™×?</h3>
        <div class="sub-grid">
            <button class="sub-btn" onclick="selectSub('wedding', this)">×—×ª×•× ×” ğŸ’</button>
            <button class="sub-btn" onclick="selectSub('bar_mitzvah', this)">×‘×¨ ××¦×•×•×” ğŸ•</button>
            <button class="sub-btn" onclick="selectSub('bat_mitzvah', this)">×‘×ª ××¦×•×•×” ğŸŒ¸</button>
            <button class="sub-btn" onclick="selectSub('brit_milah', this)">×‘×¨×™×ª ××™×œ×” ğŸ‘¶</button>
            <button class="sub-btn" onclick="selectSub('brita', this)">×‘×¨×™×ª×” ğŸ€</button>
            <button class="sub-btn" onclick="selectSub('housewarming', this)">×—× ×•×›×ª ×‘×™×ª ğŸ”‘</button>
            <button class="sub-btn" onclick="selectSub('henna', this)">×—×™× ×” ğŸ¤š</button>
        </div>
    </div>

    <div id="birthSection" class="dynamic-section">
        <h3>××–×œ ×˜×•×‘! ××” × ×•×œ×“?</h3>
        <div class="sub-grid">
            <button class="sub-btn" onclick="selectSub('birth_boy', this)">×œ×™×“×ª ×‘×Ÿ ğŸ’™ğŸ‘¶</button>
            <button class="sub-btn" onclick="selectSub('birth_girl', this)">×œ×™×“×ª ×‘×ª ğŸ’–ğŸ‘¶</button>
        </div>
    </div>

    <div id="genderSection" class="dynamic-section">
         <h3>×œ××™ ×”×‘×¨×›×”?</h3>
         <div class="sub-grid">
             <button class="sub-btn" onclick="selectGenderGeneral('male', this)">×œ×‘×¢×œ×™ / ×‘×Ÿ ×–×•×’×™ ğŸ¤µ</button>
             <button class="sub-btn" onclick="selectGenderGeneral('female', this)">×œ××©×ª×™ / ×‘×ª ×–×•×’×ª×™ ğŸ‘°</button>
         </div>
    </div>

    <div id="birthdaySection" class="dynamic-section">
        <h3>×œ××™ ×™×•× ×”×”×•×œ×“×ª?</h3>
        <div class="sub-grid" style="grid-template-columns: repeat(4, 1fr);">
            <button class="sub-btn" onclick="selectGender('man', this)">×’×‘×¨ ğŸ‘¨</button>
            <button class="sub-btn" onclick="selectGender('woman', this)">××™×©×” ğŸ‘©</button>
            <button class="sub-btn" onclick="selectGender('boy', this)">×™×œ×“ ğŸ‘¦</button>
            <button class="sub-btn" onclick="selectGender('girl', this)">×™×œ×“×” ğŸ‘§</button>
        </div>
        <div id="relationsContainer" style="display:none; margin-top:10px;">
            <div class="sub-grid" id="relationsGrid" style="grid-template-columns: repeat(3, 1fr);"></div>
        </div>
    </div>
    
    <div id="inputSection" class="dynamic-section" style="display:none;">
        <div class="input-row">
            <input type="text" id="nameInput" placeholder="×©× (××•×¤×¦×™×•× ×œ×™)" list="nameHistory">
            <datalist id="nameHistory"></datalist>
            <input type="number" id="ageInput" placeholder="×’×™×œ (××•×¤×¦×™×•× ×œ×™)">
        </div>
    </div>

    <button class="generate-btn" id="genBtn" onclick="generateBlessing()" style="display:none;">ğŸ ×¦×•×¨ ×‘×¨×›×”</button>
    
    <div class="output-container" id="output">
        <div style="opacity:0.5; text-align:center; padding-top:10px;">×”×‘×¨×›×” ×ª×•×¤×™×¢ ×›××Ÿ...</div>
    </div>

    <div class="actions-bar">
        <button class="action-btn btn-copy" onclick="copyText()">ğŸ“„ ×”×¢×ª×§</button>
        <button class="action-btn btn-whatsapp" onclick="sendWhatsapp()">×©×œ×— ×œ×•×•×¦××¤</button>
    </div>
</div>

<script>
    let generators = {};
    let state = { category: null, subCategory: null, shabbatTime: null, holidayName: null, holidayTarget: null, chabadDate: null, chabadTarget: null, timeOfDay: null, length: 'long', gender: null, relation: null, useEmojis: true, senderGender: 'male' };

    // --- ×¨×©×™××•×ª ×›×™× ×•×™×™ ×”×—×™×‘×” ×”×—×“×©×•×ª ---
    const wifeSuffixes = [
        "×”××•×©×œ××ª", "×”×™×¤×” ×©×œ×™", "××”×‘×ª ×—×™×™", "××œ×›×ª×™", "×”××—×ª ×•×”×™×—×™×“×”", 
        "×”×—×¦×™ ×”×©× ×™ ×©×œ×™", "×”× ×¡×™×›×” ×©×œ×™", "××•×¦×¨ ×©×œ×™", "×”××”×××ª", 
        "××©×ª ×—×™×œ ×©×œ×™", "×”××•×¨ ×©×œ ×”×‘×™×ª", "×”×œ×‘ ×©×œ×™", "×›×œ ×¢×•×œ××™", "×”×™×§×¨×” ××›×œ"
    ];

    const husbandSuffixes = [
        "×”××•×©×œ×", "×”×’×‘×¨ ×©×œ×™", "××”×‘×ª ×—×™×™", "××œ×š ×”×¢×•×œ×", "×”××—×“ ×•×”×™×—×™×“",
        "×”×—×¦×™ ×”×©× ×™ ×©×œ×™", "×”× ×¡×™×š ×©×œ×™", "××œ×•×£ ×©×œ×™", "×”×¡×œ×¢ ×©×œ×™",
        "×”××•×¦×¨ ×©×œ×™", "×”×™×§×¨ ×‘××“×", "×”×œ×‘ ×©×œ×™", "×¢×˜×¨×ª ×¨××©×™", "×”××‘× ×”×›×™ ×˜×•×‘ ×‘×¢×•×œ×"
    ];
    // -----------------------------------

    const jsonFiles = [
        "https://raw.githubusercontent.com/Yossi65/berkot/dac4ecf4323f439cba0ddc369665e510983332b1/(%D7%91%D7%95%D7%A7%D7%A8%2C%20%D7%A6%D7%94%D7%A8%D7%99%D7%99%D7%9D%2C%20%D7%A2%D7%A8%D7%91).json",
        "https://raw.githubusercontent.com/Yossi65/berkot/dac4ecf4323f439cba0ddc369665e510983332b1/%D7%90%D7%99%D7%A8%D7%95%D7%A2.json",
        "https://raw.githubusercontent.com/Yossi65/berkot/dac4ecf4323f439cba0ddc369665e510983332b1/%D7%94%D7%A6%D7%9C%D7%97%D7%94%20.json",
        "https://raw.githubusercontent.com/Yossi65/berkot/dac4ecf4323f439cba0ddc369665e510983332b1/%D7%97%D7%91%D7%93.json",
        "https://raw.githubusercontent.com/Yossi65/berkot/dac4ecf4323f439cba0ddc369665e510983332b1/%D7%97%D7%92.json",
        "https://raw.githubusercontent.com/Yossi65/berkot/dac4ecf4323f439cba0ddc369665e510983332b1/%D7%99%D7%95%D7%9D%20%D7%94%D7%95%D7%9C%D7%93%D7%AA%20.json",
        "https://raw.githubusercontent.com/Yossi65/berkot/dac4ecf4323f439cba0ddc369665e510983332b1/%D7%9C%D7%90%D7%94%D7%91%D7%94.json",
        "https://raw.githubusercontent.com/Yossi65/berkot/dac4ecf4323f439cba0ddc369665e510983332b1/%D7%9C%D7%99%D7%93%D7%94.json",
        "https://raw.githubusercontent.com/Yossi65/berkot/dac4ecf4323f439cba0ddc369665e510983332b1/%D7%A8%D7%A4%D7%95%D7%90%D7%94.json",
        "https://raw.githubusercontent.com/Yossi65/berkot/dac4ecf4323f439cba0ddc369665e510983332b1/%D7%A9%D7%91%D7%AA%20%D7%95%D7%9E%D7%95%D7%A6%D7%90%D7%99%20%D7%A9%D7%91%D7%AA.json",
        "https://raw.githubusercontent.com/Yossi65/berkot/dac4ecf4323f439cba0ddc369665e510983332b1/%D7%AA%D7%95%D7%93%D7%94.json"
    ];

    window.onload = function() {
        const savedSender = localStorage.getItem('senderGender') || 'male';
        setSenderGender(savedSender); 

        const savedEmojiState = localStorage.getItem('useEmojis');
        if (savedEmojiState !== null) {
            state.useEmojis = (savedEmojiState === 'true');
        }
        updateEmojiUI(); 

        const savedLength = localStorage.getItem('blessingLength');
        if (savedLength) {
            state.length = savedLength;
            const radio = document.querySelector(`input[name="length"][value="${savedLength}"]`);
            if(radio) radio.checked = true;
        }
        
        loadAllBlessings();
        loadNameHistory(); // ×˜×¢×™× ×ª ×”×™×¡×˜×•×¨×™×™×ª ×©××•×ª
    };

    // --- × ×™×”×•×œ ×”×™×¡×˜×•×¨×™×™×ª ×©××•×ª ---
    function loadNameHistory() {
        let history = JSON.parse(localStorage.getItem('nameHistory') || '[]');
        const datalist = document.getElementById('nameHistory');
        datalist.innerHTML = '';
        history.forEach(n => {
            const option = document.createElement('option');
            option.value = n;
            datalist.appendChild(option);
        });
    }

    function saveNameHistory(name) {
        if(!name) return;
        let history = JSON.parse(localStorage.getItem('nameHistory') || '[]');
        if(!history.includes(name)) {
            history.push(name);
            localStorage.setItem('nameHistory', JSON.stringify(history));
            loadNameHistory(); // ×¢×“×›×•×Ÿ ××™×™×“×™
        }
    }
    // ----------------------------

    async function loadAllBlessings() {
        const loadingStatus = document.getElementById('loadingStatus');
        
        try {
            const promises = jsonFiles.map(url => fetch(url).then(res => {
                if(!res.ok) throw new Error(`× ×›×©×œ ×‘×˜×¢×™× ×ª: ${url}`);
                return res.json();
            }));

            const results = await Promise.all(promises);

            results.forEach(data => {
                generators = { ...generators, ...data };
            });

            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('genBtn').disabled = false;
            document.getElementById('genBtn').style.display = 'none'; 

        } catch (error) {
            console.error(error);
            loadingStatus.innerText = "âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×. × ×¡×” ×œ×¨×¢× ×Ÿ.";
            loadingStatus.style.color = "red";
        }
    }

    function updateSenderUI() {
        document.getElementById('senderMale').classList.remove('active');
        document.getElementById('senderFemale').classList.remove('active');
        
        if (state.senderGender === 'male') {
            document.getElementById('senderMale').classList.add('active');
            document.documentElement.style.setProperty('--primary', '#4a90e2');
            document.documentElement.style.setProperty('--primary-dark', '#357abd');
            document.documentElement.style.setProperty('--bg', '#b3e5fc'); 
            document.documentElement.style.setProperty('--card', '#f0f8ff'); 
            document.documentElement.style.setProperty('--controls-bg', '#e1f5fe');
        } else {
            document.getElementById('senderFemale').classList.add('active');
            document.documentElement.style.setProperty('--primary', '#e91e63'); 
            document.documentElement.style.setProperty('--primary-dark', '#c2185b'); 
            document.documentElement.style.setProperty('--bg', '#f8bbd0'); 
            document.documentElement.style.setProperty('--card', '#fff0f5'); 
            document.documentElement.style.setProperty('--controls-bg', '#fce4ec');
        }
    }

    function setSenderGender(g) {
        state.senderGender = g;
        localStorage.setItem('senderGender', g);
        updateSenderUI();
    }

    function setLength(len) {
        state.length = len;
        localStorage.setItem('blessingLength', len);
    }

    const emojis = {
        shabbat: ["ğŸ•¯ï¸", "ğŸ·", "âœ¨", "ğŸ¥–", "ğŸ•", "ğŸ‡", "ğŸ¤", "ğŸ•Šï¸", "ğŸ¡", "ğŸ’"],
        motzash: ["ğŸ¸", "ğŸ•¯ï¸", "ğŸ·", "âœ¨", "ğŸŒš", "ğŸ¶", "ğŸ’«", "ğŸ¯", "ğŸ§¿", "ğŸŒŸ"],
        morning: ["â˜€ï¸", "â˜•", "ğŸŒ¼", "ğŸ¥", "ğŸ§¡", "âœ¨", "×™×•× × ×¤×œ×"],
        noon: ["ğŸŒ¤ï¸", "ğŸ¥—", "ğŸ¥¤", "ğŸ˜", "ğŸ’ª", "×”××©×š ×™×•× × ×¢×™×"],
        night: ["ğŸŒ™", "â­", "ğŸ’¤", "ğŸ›ï¸", "âœ¨", "×—×œ×•××•×ª ×¤×–"],
        
        wedding: ["ğŸ’", "ğŸ’’", "ğŸ¥‚", "ğŸ¤µ", "ğŸ‘°"],
        bar_mitzvah: ["ğŸ“–", "ğŸ¬", "ğŸ•", "âœ¡ï¸", "ğŸ’™"],
        bat_mitzvah: ["ğŸ“–", "ğŸŒ¸", "ğŸ•", "âœ¡ï¸", "ğŸ’–"],
        brit_milah: ["ğŸ‘¶", "ğŸ¼", "ğŸ’™", "âœ¡ï¸"],
        brita: ["ğŸ‘¶", "ğŸ¼", "ğŸ’–", "ğŸŒ¸"],
        birth_boy: ["ğŸ‘¶", "ğŸ’™", "ğŸ¼", "ğŸš™", "ğŸ§¸"],
        birth_girl: ["ğŸ‘¶", "ğŸ’–", "ğŸ€", "ğŸŒ¸", "ğŸ¦„"],
        housewarming: ["ğŸ ", "ğŸ”‘", "ğŸª´", "ğŸ§¿"],
        henna: ["ğŸ¤š", "ğŸ¬", "ğŸ•Œ", "ğŸ‘˜"],
        birthday: ["ğŸ‚", "ğŸ¥³", "ğŸ", "ğŸˆ", "ğŸ°"],
        general: ["âœ¨", "ğŸŒ¸", "ğŸ’«", "ğŸŒŸ", "ğŸ™Œ", "ğŸ’", "ğŸ’", "ğŸ¦‹", "ğŸŒˆ", "â˜€ï¸"],
        recovery: ["ğŸ’Š", "ğŸ©º", "ğŸ’ª", "â¤ï¸"],
        love: ["â¤ï¸", "ğŸ˜", "ğŸ’‹", "ğŸ’˜", "ğŸŒ¹"],
        success: ["ğŸ†", "ğŸ’¼", "ğŸš€", "ğŸ“ˆ", "â­", "ğŸ’°"],
        thank_you: ["ğŸ™", "ğŸ’", "ğŸ’–", "ğŸŒº"],
        rosh_hashanah: ["ğŸ", "ğŸ¯", "ğŸ"],
        hanukkah: ["ğŸ•", "ğŸ©", "ğŸ•¯ï¸"],
        passover: ["ğŸ·", "ğŸ¥¬"],
        purim: ["ğŸ­", "ğŸ·"],
        tu_bishvat: ["ğŸŒ³", "ğŸŒ±", "ğŸ‡", "ğŸŠ", "ğŸŒ§ï¸"],
        simchat_torah: ["ğŸ“œ", "ğŸ’ƒ", "ğŸ•", "ğŸ™Œ"],
        yom_haatzmaut: ["ğŸ‡®ğŸ‡±", "ğŸ†", "ğŸ’™", "ğŸ–"],
        lag_baomer: ["ğŸ”¥", "ğŸ¥”", "ğŸ•¯ï¸", "ğŸ¹"],
        tu_beav: ["â¤ï¸", "ğŸ’‘", "ğŸ’", "ğŸ’Œ"],
        rosh_chodesh: ["ğŸŒ‘", "ğŸ“…", "âœ¨", "ğŸ™"],
        mimouna: ["ğŸ¥", "ğŸ¯", "ğŸª", "ğŸª•"],
        chabad: ["ğŸ‘‘", "ğŸ•¯ï¸", "ğŸ•", "ğŸ“œ", "ğŸ“–"]
    };

    function updateEmojiUI() {
        const btn = document.getElementById('emojiBtn');
        const icon = document.getElementById('emojiIcon');
        if (state.useEmojis) {
            btn.classList.add('active');
            icon.innerText = "âœ…";
        } else {
            btn.classList.remove('active');
            icon.innerText = "âšª";
        }
    }

    function toggleEmoji() {
        state.useEmojis = !state.useEmojis;
        localStorage.setItem('useEmojis', state.useEmojis);
        updateEmojiUI();
    }

    function goBack() {
        let currentEmojiState = state.useEmojis;
        let currentSender = state.senderGender;
        let currentLength = state.length;
        state = { category: null, subCategory: null, shabbatTime: null, holidayName: null, holidayTarget: null, chabadDate: null, chabadTarget: null, timeOfDay: null, length: currentLength, gender: null, relation: null, useEmojis: currentEmojiState, senderGender: currentSender };
        
        document.getElementById('nameInput').value = "";
        document.getElementById('ageInput').value = "";
        document.getElementById('output').innerHTML = '<div style="opacity:0.5; text-align:center; padding-top:10px;">×”×‘×¨×›×” ×ª×•×¤×™×¢ ×›××Ÿ...</div>';
        document.getElementById('mainGrid').style.display = 'grid';
        
        document.getElementById('genBtn').style.display = 'none';
        
        document.querySelectorAll('.dynamic-section').forEach(el => el.style.display = 'none');
        document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        
        document.getElementById('holidayTargetSelector').style.display = 'none';
        document.getElementById('timeTargetSelector').style.display = 'none';
        
        updateSenderUI();
    }

    function selectCategory(cat, btn) {
        state.category = cat;
        document.getElementById('mainGrid').style.display = 'none';
        document.getElementById('inputSection').style.display = 'block';
        
        if (cat === 'morning_evening') {
            document.getElementById('morningEveningSection').style.display = 'block';
            document.getElementById('timeTargetSelector').style.display = 'none';
        }
        else if (cat === 'shabbat') {
            document.getElementById('shabbatSection').style.display = 'block';
            document.getElementById('shabbatTimeSelector').style.display = 'block';
            document.getElementById('shabbatTargetSelector').style.display = 'none';
        }
        else if (cat === 'holiday') {
            document.getElementById('holidaySection').style.display = 'block';
            document.getElementById('holidayNameSelector').style.display = 'block';
            document.getElementById('holidayTargetSelector').style.display = 'none';
        }
        else if (cat === 'chabad') {
            document.getElementById('chabadSection').style.display = 'block';
        }
        else if (cat === 'event') document.getElementById('eventSection').style.display = 'block';
        else if (cat === 'birth') document.getElementById('birthSection').style.display = 'block';
        else if (cat === 'birthday') document.getElementById('birthdaySection').style.display = 'block';
        else {
            if(['success', 'recovery', 'thank_you', 'love'].includes(cat)) {
                document.getElementById('genderSection').style.display = 'block';
            } else {
                document.getElementById('genBtn').style.display = 'block';
            }
        }
    }

    function selectTimeOfDay(time, btn) {
        state.timeOfDay = time;
        const btns = document.querySelectorAll('#timeOfDaySelector .sub-btn');
        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('timeTargetSelector').style.display = 'block';
        document.getElementById('genBtn').style.display = 'none'; 
    }

    function selectTimeTarget(target, btn) {
        state.subCategory = target;
        const btns = document.querySelectorAll('#timeTargetSelector .sub-btn');
        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('genBtn').style.display = 'block';
    }

    function selectShabbatTime(time) {
        state.shabbatTime = time;
        const btns = document.querySelectorAll('#shabbatTimeSelector .sub-btn');
        btns.forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('shabbatTargetSelector').style.display = 'block';
        document.getElementById('genBtn').style.display = 'block';
    }

    function selectSub(type, btn) {
        if (type.startsWith('chabad_')) {
            state.chabadDate = type;
            let parent = btn.parentElement;
            parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (state.chabadTarget) document.getElementById('genBtn').style.display = 'block';
            return;
        }
        
        if (state.category === 'chabad' && !type.startsWith('chabad_')) {
            state.chabadTarget = type;
            let parent = btn.parentElement;
            parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (state.chabadDate) document.getElementById('genBtn').style.display = 'block';
            return;
        }

        state.subCategory = type;
        let parent = btn.parentElement;
        parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('genBtn').style.display = 'block';
    }

    function selectHolidayName(hName, btn) {
        state.holidayName = hName;
        const btns = document.querySelectorAll('#holidayNameSelector .sub-btn');
        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('holidayTargetSelector').style.display = 'block';
        document.getElementById('genBtn').style.display = 'block';
    }

    function selectHolidayTarget(target, btn) {
        state.holidayTarget = target;
        const btns = document.querySelectorAll('#holidayTargetSelector .sub-btn');
        btns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function selectGenderGeneral(g, btn) {
        state.gender = g;
        let parent = btn.parentElement;
        parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('genBtn').style.display = 'block';
    }

    function selectGender(gender, btn) {
        state.gender = gender;
        let parent = btn.parentElement;
        parent.querySelectorAll('.sub-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const relationsMap = {
            man: ["××‘× ğŸ‘‘", "××— ğŸ‘Š", "×—×‘×¨ ğŸ»", "×‘×Ÿ ×–×•×’×™ ğŸ’‘", "×‘×¢×œ×™ ğŸ’"],
            woman: ["××× ğŸ‘‘", "××—×•×ª ğŸŒ¸", "×—×‘×¨×” ğŸ‘¯â€â™€ï¸", "×‘×ª ×–×•×’×ª×™ ğŸ’‘", "××©×ª×™ ğŸ’"],
            boy: ["×™×œ×“ âš½", "×‘×Ÿ ğŸ’™", "× ×›×“ ğŸ§¸", "×—×‘×¨ ğŸš²", "×”×™×œ×“ ×©×œ×™ ğŸ‘¦"],
            girl: ["×™×œ×“×” ğŸ€", "×‘×ª ğŸ’–", "× ×›×“×” ğŸ¦„", "×—×‘×¨×” ğŸ‘­", "×”×™×œ×“×” ×©×œ×™ ğŸ‘§"]
        };
        
        const grid = document.getElementById('relationsGrid');
        grid.innerHTML = '';
        (relationsMap[gender] || []).forEach(rel => {
            const b = document.createElement('button');
            b.className = 'sub-btn';
            b.innerText = rel;
            const pureRel = rel.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g, '').trim();
            b.onclick = (e) => {
                state.relation = pureRel;
                grid.querySelectorAll('.sub-btn').forEach(x => x.classList.remove('active'));
                e.target.classList.add('active');
            };
            grid.appendChild(b);
        });
        document.getElementById('relationsContainer').style.display = 'block';
        document.getElementById('genBtn').style.display = 'block';
    }

    function getDistinctRandom(arr, count) {
        if (!arr || arr.length === 0) return [];
        const shuffled = [...arr].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, count);
    }

    function adjustTextForSender(text) {
        if (state.senderGender === 'female') {
            const replacements = [
                { m: "×××—×œ", f: "×××—×œ×ª" },
                { m: "××•×”×‘", f: "××•×”×‘×ª" },
                { m: "××¢×¨×™×š", f: "××¢×¨×™×›×”" },
                { m: "×©×•×œ×—", f: "×©×•×œ×—×ª" },
                { m: "×‘×˜×•×—", f: "×‘×˜×•×—×”" },
                { m: "×—×•×©×‘", f: "×—×•×©×‘×ª" },
                { m: "××ª×’×¢×’×¢", f: "××ª×’×¢×’×¢×ª" },
                { m: "××•×§×™×¨", f: "××•×§×™×¨×”" },
                { m: "××××™×Ÿ", f: "××××™× ×”" },
                { m: "×¡×•××š", f: "×¡×•××›×ª" },
                { m: "××—×–×™×§", f: "××—×–×™×§×”" },
                { m: "××•×“×”", f: "××•×“×”" }
            ];

            let newText = text;
            replacements.forEach(pair => {
                newText = newText.split(pair.m).join(pair.f);
            });
            return newText;
        }
        return text;
    }

    function generateBlessing() {
        if(Object.keys(generators).length === 0) {
            alert("×”×××’×¨ ×¢×“×™×™×Ÿ ×¨×™×§! ×™×™×ª×›×Ÿ ×©×”×˜×¢×™× ×” × ×›×©×œ×”.");
            return;
        }

        document.getElementsByName('length').forEach(l => { if(l.checked) state.length = l.value });
        const output = document.getElementById('output');
        let key = "";

        if (state.category === 'morning_evening') {
             if (!state.timeOfDay || !state.subCategory) { alert("× × ×œ×‘×—×•×¨ ×–××Ÿ ×•×™×¢×“..."); return; }
             key = `${state.timeOfDay}_${state.subCategory}`;
        }
        else if (state.category === 'shabbat') {
            if (!state.shabbatTime || !state.subCategory) { alert("× × ×œ×‘×—×•×¨ ×–××Ÿ ×•×™×¢×“..."); return; }
            key = `${state.shabbatTime}_${state.subCategory}`;
        }
        else if (state.category === 'holiday') {
             if (!state.holidayName || !state.holidayTarget) { alert("× × ×œ×‘×—×•×¨ ×—×’ ×•×™×¢×“..."); return; }
             key = `${state.holidayName}_${state.holidayTarget}`;
        }
        else if (state.category === 'chabad') {
             if (!state.chabadDate || !state.chabadTarget) { alert("× × ×œ×‘×—×•×¨ ×ª××¨×™×š ×•×™×¢×“..."); return; }
             key = `${state.chabadDate}_${state.chabadTarget}`;
        }
        else if (state.category === 'event') {
             if (!state.subCategory) { alert("× × ×œ×‘×—×•×¨..."); return; }
             key = state.subCategory;
        }
        else if (state.category === 'birth') {
             if (!state.subCategory) { alert("× × ×œ×‘×—×•×¨..."); return; }
             key = state.subCategory;
        }
        else if (state.category === 'birthday') {
             const bdKey = (state.gender === 'woman' || state.gender === 'girl' || state.gender === 'female') ? 'birthday_female' : 'birthday_male';
             key = bdKey;
        } 
        else if (['success', 'recovery', 'thank_you', 'love'].includes(state.category)) {
             if (!state.gender) { alert("× × ×œ×‘×—×•×¨ ××™×Ÿ..."); return; }
             key = `${state.category}_${state.gender}`;
        }
        else {
            key = state.category;
        }

        let gen = generators[key];
        
        if (!gen) {
            if (state.category === 'shabbat') gen = generators[`${state.shabbatTime}_general`];
            else if (state.category === 'holiday') gen = generators[`${state.holidayName}_general`] || generators[`${state.holidayName}`];
            else if (state.category === 'chabad') gen = generators[state.chabadDate];
        }
        
        if (!gen) { 
            output.innerHTML = `<div style="color:red; text-align:center">×œ× × ××¦××• ×‘×¨×›×•×ª ×œ×§×˜×’×•×¨×™×”: ${key}</div>`; 
            return; 
        }

        let parts = [];
        const name = document.getElementById('nameInput').value.trim();
        saveNameHistory(name); // ×©××™×¨×ª ×”×©× ×‘×”×™×¡×˜×•×¨×™×”

        if (name) {
            let suffix = "×”×™×§×¨/×”";
            
            // ×‘×“×™×§×” ×”×× ×–×• ×‘×¨×›×” ×œ××™×©×” (××• ×§×˜×’×•×¨×™×™×ª ××”×‘×” ×œ××™×©×”)
            const isWifeContext = (state.subCategory === 'wife' || state.holidayTarget === 'wife' || (state.category === 'love' && state.gender === 'female'));
            
            // ×‘×“×™×§×” ×”×× ×–×• ×‘×¨×›×” ×œ×‘×¢×œ (××• ×§×˜×’×•×¨×™×™×ª ××”×‘×” ×œ×’×‘×¨)
            const isHusbandContext = (state.subCategory === 'husband' || state.holidayTarget === 'husband' || (state.category === 'love' && state.gender === 'male'));

            // ×‘×“×™×§×•×ª ××’×“×¨ ×›×œ×œ×™×•×ª
            const isGenericFemale = (state.gender === 'woman' || state.gender === 'girl' || state.gender === 'female' || 
                              state.holidayTarget === 'sister' || state.holidayTarget === 'friend_female' ||
                              state.subCategory === 'sister' || state.subCategory === 'friend_female');
                              
            const isGenericMale = (state.gender === 'man' || state.gender === 'boy' || state.gender === 'male' ||
                            state.holidayTarget === 'brother' || state.holidayTarget === 'friend_male' ||
                            state.subCategory === 'brother' || state.subCategory === 'friend_male');

            if (isWifeContext) {
                suffix = wifeSuffixes[Math.floor(Math.random() * wifeSuffixes.length)];
            } else if (isHusbandContext) {
                suffix = husbandSuffixes[Math.floor(Math.random() * husbandSuffixes.length)];
            } else {
                if (isGenericFemale) suffix = "×”×™×§×¨×”";
                else if (isGenericMale) suffix = "×”×™×§×¨";
            }
            
            parts.push(`${name} ${suffix},`);
        }

        parts.push(getDistinctRandom(gen.openers, 1)[0]);
        const bodyCount = state.length === 'long' ? 2 : 1;
        const bodies = getDistinctRandom(gen.bodies, bodyCount);
        parts.push(...bodies);

        if (state.category !== 'morning_evening') {
            parts.push(getDistinctRandom(gen.closings, 1)[0]);
        }

        let adjustedParts = parts.map(part => adjustTextForSender(part));

        let emojiSet = 'general';
        if (state.category === 'morning_evening') emojiSet = state.timeOfDay;
        else if (state.category === 'shabbat') emojiSet = state.shabbatTime;
        else if (state.category === 'holiday') emojiSet = state.holidayName;
        else if (state.category === 'birth') emojiSet = state.subCategory;
        else if (state.category === 'chabad') emojiSet = state.chabadDate;
        else if (emojis[key]) emojiSet = key;
        else if (emojis[state.category]) emojiSet = state.category;

        if (state.category === 'chabad' && !emojis[emojiSet]) emojiSet = 'chabad';

        renderLinesWithEmojis(adjustedParts, emojiSet);
    }

    function renderLinesWithEmojis(linesArray, setKey) {
        const cleanLines = linesArray.filter(l => l && l.trim() !== "");
        let availableEmojis = [...(emojis[setKey] || emojis['general'])]; 
        
        const container = document.getElementById('output');
        container.innerHTML = ''; 

        cleanLines.forEach(line => {
            let lineContent = line.trim();
            if (state.useEmojis) {
                if (availableEmojis.length === 0) availableEmojis = [...(emojis[setKey] || emojis['general'])];
                const randomIndex = Math.floor(Math.random() * availableEmojis.length);
                const emoji = availableEmojis[randomIndex];
                availableEmojis.splice(randomIndex, 1); 
                lineContent = `${lineContent} ${emoji}`;
            }
            
            const row = document.createElement('div');
            row.className = 'line-item';
            row.innerHTML = `
                <button class="delete-line-btn" onclick="this.parentElement.remove()" title="××—×§ ×©×•×¨×” ×–×•">âœ•</button>
                <div class="line-text" contenteditable="true">*${lineContent}*</div>
            `;
            container.appendChild(row);
        });
    }

    function getVisibleText() {
        const rows = document.querySelectorAll('.line-text');
        return Array.from(rows).map(r => r.innerText.trim()).join('\n');
    }

    function copyText() {
        const textToCopy = getVisibleText();
        if(!textToCopy) return;
        
        navigator.clipboard.writeText(textToCopy);
        const btn = document.querySelector('.btn-copy');
        let old = btn.innerText; btn.innerText = "×”×•×¢×ª×§! ğŸ‘"; setTimeout(() => btn.innerText = old, 1500);
    }

    function sendWhatsapp() {
        let text = getVisibleText();
        if(!text) return alert("×§×•×“× ×¦×•×¨ ×‘×¨×›×”!");
        window.open(`whatsapp://send?text=${encodeURIComponent(text)}`, '_blank');
    }
</script>

</body>
</html>
